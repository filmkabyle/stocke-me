<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ุฅุฏุงุฑุฉ ุงููุญู ุงูุชุฌุงุฑู - ูุณุฎุฉ ูุทูุฑุฉ ุดุงููุฉ</title>
    <style>
        :root {
            --primary-color: #2c3e50; /* Navy Blue */
            --secondary-color: #3498db; /* Bright Blue */
            --accent-color: #1abc9c; /* Turquoise */
            --danger-color: #e74c3c; /* Red */
            --warning-color: #f39c12; /* Orange */
            --info-color: #3498db; /* Bright Blue (can reuse) */
            --success-color: #2ecc71; /* Green */
            --light-gray: #ecf0f1;
            --medium-gray: #bdc3c7;
            --dark-gray: #7f8c8d;
            --text-color: #333;
            --white: #fff;
            --font-family: 'Tahoma', sans-serif;
            --sidebar-width: 260px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: #f4f7f6;
            color: var(--text-color);
            direction: rtl;
            font-size: 14px;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: var(--light-gray);
            padding: 20px;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1100;
            transform: translateX(100%); /* Hidden by default on mobile */
        }
        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .sidebar-header h2 {
            color: var(--accent-color);
            margin: 0;
            font-size: 1.6em;
        }
        .sidebar-header p {
            font-size: 0.8em;
            color: var(--medium-gray);
        }

        .sidebar nav ul {
            list-style-type: none;
            padding: 0;
        }

        .sidebar nav ul li a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            color: var(--light-gray);
            text-decoration: none;
            border-radius: 5px;
            margin-bottom: 8px;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 1em;
        }
        .sidebar nav ul li a .icon { font-size: 1.1em; width: 20px; text-align: center; }

        .sidebar nav ul li a:hover, .sidebar nav ul li a.active {
            background-color: var(--accent-color);
            color: var(--primary-color);
            font-weight: bold;
        }

        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            transition: margin-right 0.3s ease;
            margin-right: 0; /* No margin on mobile */
        }

        .menu-toggle {
            display: none; /* Hidden by default */
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1200;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.5em;
            line-height: 1;
        }
         .menu-toggle .icon-menu, .menu-toggle .icon-close {
            display: block;
        }
        .menu-toggle .icon-close { display: none; }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .page-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--medium-gray);
            gap: 10px;
        }
        .page-header h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 1.6em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            background-color: var(--white);
            font-size: 0.9em;
        }
        .table-responsive-wrapper {
            overflow-x: auto;
            width: 100%;
            margin-bottom: 15px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px 10px;
            text-align: right;
            vertical-align: middle;
            white-space: nowrap; /* Keep table cells from breaking line on header */
        }
        td { white-space: normal; } /* Allow content in data cells to wrap */

        th {
            background-color: var(--secondary-color);
            color: var(--white);
            font-weight: bold;
        }

        tr:nth-child(even) { background-color: #f9f9f9; }

        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark-gray);
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--accent-color);
            outline: none;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }

        button, .button {
            background-color: var(--accent-color);
            color: var(--white);
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background-color 0.2s ease, transform 0.1s ease;
            margin-left: 5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        button:hover, .button:hover { background-color: #16a085;  }
        button:active, .button:active { transform: translateY(1px); }
        button:disabled, .button:disabled {
            background-color: var(--medium-gray);
            cursor: not-allowed;
            color: var(--dark-gray);
        }
        button:disabled:hover, .button:disabled:hover {
             background-color: var(--medium-gray);
        }


        button.primary, .button.primary { background-color: var(--secondary-color); }
        button.primary:hover, .button.primary:hover { background-color: #2980b9; }
        button.danger, .button.danger { background-color: var(--danger-color); }
        button.danger:hover, .button.danger:hover { background-color: #c0392b; }
        button.warning, .button.warning { background-color: var(--warning-color); }
        button.warning:hover, .button.warning:hover { background-color: #d35400; }
        button.info, .button.info { background-color: var(--info-color); }
        button.info:hover, .button.info:hover { background-color: #2980b9; }
        button.success, .button.success { background-color: var(--success-color); }
        button.success:hover, .button.success:hover { background-color: #27ae60; }
        button.small { padding: 6px 10px; font-size: 0.8em;}

        .action-buttons button { margin-top: 0; margin-bottom: 5px; }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 5px; }

        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6);
            animation: fadeInModal 0.3s;
        }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background-color: var(--white);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888; width: 90%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slideInModal 0.3s;
        }
        @keyframes slideInModal { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
        }
        .modal-header h3 { margin: 0; color: var(--primary-color); font-size: 1.3em; }
        .close-button {
            color: var(--dark-gray); font-size: 24px;
            font-weight: bold; cursor: pointer; transition: color 0.2s;
        }
        .close-button:hover, .close-button:focus { color: var(--danger-color); text-decoration: none;}

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background-color: var(--white); padding: 15px;
            border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center; transition: transform 0.2s ease;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-card .icon { font-size: 2em; color: var(--secondary-color); margin-bottom: 8px; }
        .stat-card h3 { margin-top: 0; color: var(--primary-color); font-size: 1em;}
        .stat-card p { font-size: 1.8em; font-weight: bold; color: var(--accent-color); margin: 5px 0 0;}

        #posProductSearchResults {
            border: 1px solid var(--medium-gray);
            max-height: 150px;
            overflow-y: auto;
            background-color: var(--white); border-radius: 4px;
            margin-top: 5px;
        }
        #posProductSearchResults ul { list-style: none; padding: 0; margin: 0;}
        #posProductSearchResults li {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
            font-size: 0.9em;
        }
        #posProductSearchResults li:last-child { border-bottom: none; }
        #posProductSearchResults li:hover { background-color: #f0f0f0; }
        #posProductSearchResults li .stock { font-size: 0.8em; color: var(--dark-gray); }

        .text-danger { color: var(--danger-color); }
        .text-success { color: var(--accent-color); }
        .mt-1 { margin-top: 10px; }
        .mt-2 { margin-top: 20px; }
        .mb-1 { margin-bottom: 10px; }
        .mb-2 { margin-bottom: 20px; }
        .d-flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .text-left { text-align: left; }
        .badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            color: var(--white);
            font-weight: bold;
        }
        .badge-danger { background-color: var(--danger-color); }
        .badge-success { background-color: var(--success-color); }
        .badge-warning { background-color: var(--warning-color); }
        .badge-info { background-color: var(--info-color); }
        .badge-secondary { background-color: var(--medium-gray); color: var(--text-color); }


        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 5px;
            color: white;
            z-index: 2000;
            font-size: 1em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, bottom 0.3s ease-in-out;
            text-align: center;
        }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        .toast.info { background-color: var(--info-color); }
        .toast.show { opacity: 1; bottom: 30px; }

        #poItemsTable td input[type="number"],
        #poItemsTable td input[type="text"],
        #quoteItemsTable td input[type="number"],
        #quoteItemsTable td input[type="text"]
        {
            width: 80px;
            padding: 5px;
            font-size: 0.9em;
            text-align: center;
        }
        #poItemsTable td:first-child,
        #quoteItemsTable td:first-child {
            width: auto;
            white-space: normal;
        }

        /* --- STYLES FOR PRINTING --- */
        @media print {
            body, html {
                background: var(--white) !important;
                color: #000 !important;
                margin: 0;
                padding: 0;
            }
            .sidebar, .main-content > .page-header, .menu-toggle, .modal, .toast, .no-print,
            button, .button, .action-buttons {
                display: none !important;
            }
            .main-content {
                margin-right: 0 !important;
                padding: 0 !important;
            }
            body > *:not(#invoiceToPrint) {
                display: none !important;
            }
            #invoiceToPrint {
                display: block !important;
                visibility: visible !important;
                position: static !important;
                width: 100%;
                margin: 0 auto;
                padding: 10mm;
                box-shadow: none;
                border: none;
                font-family: Arial, sans-serif;
                font-size: 12pt;
                color: #000 !important;
            }
            #invoiceToPrint * {
                visibility: visible !important;
                color: #000 !important;
                background-color: transparent !important;
            }
            #invoiceToPrint h1, #invoiceToPrint h2, #invoiceToPrint h3 {
                text-align: center;
                margin-bottom: 15px;
            }
            #invoiceToPrint table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
            }
            #invoiceToPrint th, #invoiceToPrint td {
                border: 1px solid #666 !important;
                padding: 8px;
                text-align: right;
            }
            #invoiceToPrint th { background-color: #eee !important; }
            #invoiceToPrint .invoice-header p, #invoiceToPrint .invoice-summary p { margin: 5px 0; }
            #invoiceToPrint .invoice-summary {
                margin-top: 20px;
                text-align: left;
                padding-right: 10px;
            }
             #invoiceToPrint .invoice-summary p {
                text-align: right !important; /* Force right align for summary */
             }
        }

        @media (min-width: 768px) {
            .sidebar {
                position: sticky;
                transform: translateX(0);
                height: 100vh;
            }
            .main-content {
                margin-right: var(--sidebar-width);
            }
            .menu-toggle {
                display: none;
            }
            table { font-size: 1em; }
            th, td { white-space: normal; }
            .modal-content { margin: 8% auto; }
        }

        @media (max-width: 767px) {
            .menu-toggle {
                display: block;
            }
            .page-header h1 {
                font-size: 1.4em;
                width: 100%;
                text-align: center;
            }
            .page-header button {
                font-size: 0.9em;
                padding: 8px 12px;
                width: 100%;
                margin-top: 10px;
            }
            #pos > div:first-of-type { /* POS layout adjustment */
                flex-direction: column;
            }
            #pos > div:first-of-type > div:first-child { /* POS search and cart */
                margin-bottom: 20px;
            }
            .stats-cards {
                grid-template-columns: 1fr;
            }
            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            .action-buttons button {
                width: 100%;
                margin-left: 0;
            }
            .form-group.d-flex {
                flex-direction: column;
                align-items: stretch;
            }
            .form-group.d-flex input[type="date"], .form-group.d-flex button {
                width: 100%;
                margin-top: 5px;
            }
            #saleConfirmationModal .modal-content div > button {
                width: 100%;
                margin-bottom: 10px;
            }
             #saleConfirmationModal .modal-content div > button:last-child {
                margin-bottom: 0;
            }
             .modal-content {
                margin: 10% auto;
            }
        }
    </style>
</head>
<body>
    <button class="menu-toggle" id="menuToggleBtn">
        <span class="icon-menu">โฐ</span>
        <span class="icon-close">โ</span>
    </button>

    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><span class="icon">๐๏ธ</span> ูุธุงู ุงูุฅุฏุงุฑุฉ</h2>
                <p>ูุญู ุชุฌุงุฑู ูุทูุฑ</p>
            </div>
            <nav>
                <ul>
                    <li><a href="#" class="nav-link active" data-page="dashboard"><span class="icon">๐</span> ููุญุฉ ุงูุชุญูู</a></li>
                    <li><a href="#" class="nav-link" data-page="pos"><span class="icon">๐</span> ููุทุฉ ุงูุจูุน (POS)</a></li>
                    <li><a href="#" class="nav-link" data-page="products"><span class="icon">๐ฆ</span> ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</a></li>
                    <li><a href="#" class="nav-link" data-page="categories"><span class="icon">๐ท๏ธ</span> ูุฆุงุช ุงูููุชุฌุงุช</a></li>
                    <li><a href="#" class="nav-link" data-page="inventory"><span class="icon">๐</span> ุฅุฏุงุฑุฉ ุงููุฎุฒูู</a></li>
                    <li><a href="#" class="nav-link" data-page="sales"><span class="icon">๐</span> ุงููุจูุนุงุช ูุงูุชูุงุฑูุฑ</a></li>
                    <li><a href="#" class="nav-link" data-page="customers"><span class="icon">๐ฅ</span> ุฅุฏุงุฑุฉ ุงูุนููุงุก</a></li>
                    <li><a href="#" class="nav-link" data-page="customerDebts"><span class="icon">๐</span> ุฏููู ุงูุนููุงุก</a></li>
                    <li><a href="#" class="nav-link" data-page="suppliers"><span class="icon">๐</span> ุฅุฏุงุฑุฉ ุงูููุฑุฏูู</a></li>
                    <li><a href="#" class="nav-link" data-page="purchaseOrders"><span class="icon">๐งพ</span> ุทูุจุงุช ุงูุดุฑุงุก</a></li>
                    <li><a href="#" class="nav-link" data-page="quotations"><span class="icon">๐</span> ุนุฑูุถ ุงูุฃุณุนุงุฑ</a></li>
                    <li><a href="#" class="nav-link" data-page="expenses"><span class="icon">๐ธ</span> ุฅุฏุงุฑุฉ ุงููุตุฑููุงุช</a></li>
                    <li><a href="#" class="nav-link" data-page="settings"><span class="icon">โ๏ธ</span> ุงูุฅุนุฏุงุฏุงุช</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content" id="mainContent">
            <!-- Dashboard Page -->
            <section id="dashboard" class="page active">
                <div class="page-header"><h1>ููุญุฉ ุงูุชุญูู ุงูุฑุฆูุณูุฉ</h1></div>
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="icon">๐ฆ</div>
                        <h3>ุฅุฌูุงูู ุงูููุชุฌุงุช</h3>
                        <p id="total-products-stat">0</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon">๐ฐ</div>
                        <h3>ุฅุฌูุงูู ูุจูุนุงุช ุงูููู</h3>
                        <p id="total-sales-today-stat">0.00</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon">โ๏ธ</div>
                        <h3>ููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู</h3>
                        <p id="low-stock-products-stat">0</p>
                    </div>
                     <div class="stat-card">
                        <div class="icon">๐ฅ</div>
                        <h3>ุฅุฌูุงูู ุงูุนููุงุก</h3>
                        <p id="total-customers-stat">0</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon">๐</div>
                        <h3>ุฅุฌูุงูู ุงูุฏููู</h3>
                        <p id="total-debts-stat">0.00</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon">๐ธ</div>
                        <h3>ุฅุฌูุงูู ูุตุฑููุงุช ุงูุดูุฑ</h3>
                        <p id="total-expenses-month-stat">0.00</p>
                    </div>
                </div>
                <h3>ุฃุญุฏุซ 5 ูุจูุนุงุช</h3>
                <div class="table-responsive-wrapper">
                    <table id="latest-sales-table">
                        <thead><tr><th>ุฑูู ุงููุงุชูุฑุฉ</th><th>ุงูุชุงุฑูุฎ</th><th>ุงูุนููู</th><th>ุงูุฅุฌูุงูู</th><th>ุงูุฅุฌุฑุงุก</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                 <h3 class="mt-2">ุฃุญุฏุซ 5 ุทูุจุงุช ุดุฑุงุก</h3>
                <div class="table-responsive-wrapper">
                    <table id="latest-purchase-orders-table">
                        <thead><tr><th>ุฑูู ุงูุทูุจ</th><th>ุงูููุฑุฏ</th><th>ุชุงุฑูุฎ ุงูุทูุจ</th><th>ุงูุญุงูุฉ</th><th>ุงูุฅุฌูุงูู</th><th>ุงูุฅุฌุฑุงุก</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- POS Page -->
            <section id="pos" class="page">
                <div class="page-header"><h1>ููุทุฉ ุงูุจูุน (POS)</h1></div>
                <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                    <div style="flex: 2; min-width: 300px;">
                        <div class="form-group">
                            <label for="posProductSearch">ุจุญุซ ุนู ููุชุฌ (ุจุงูุงุณูุ ุงูููุฏุ ุงูุจุงุฑููุฏ):</label>
                            <input type="text" id="posProductSearch" placeholder="ุงุจุฏุฃ ุงููุชุงุจุฉ ููุจุญุซ...">
                            <div id="posProductSearchResults"></div>
                        </div>
                        <h3>ูุงุชูุฑุฉ ุญุงููุฉ</h3>
                        <div class="table-responsive-wrapper">
                            <table id="posCartTable">
                                <thead><tr><th>ุงูููุชุฌ</th><th>ุงููููุฉ</th><th>ุงูุณุนุฑ</th><th>ุงูุฅุฌูุงูู</th><th>ุฅุฌุฑุงุก</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 250px;">
                        <h3>ุชูุงุตูู ุงููุงุชูุฑุฉ</h3>
                        <div class="form-group">
                            <label for="posCustomerSelect">ุงูุนููู:</label>
                            <select id="posCustomerSelect">
                                <option value="">ุนููู ุนุงู</option>
                            </select>
                        </div>
                        <hr>
                        <div style="text-align: left; margin-top: 10px;">
                            <h4>ุงูุฅุฌูุงูู ุงููุฑุนู: <span id="posSubtotalAmount">0.00</span></h4>
                            <h4>ุงูุถุฑูุจุฉ (<span id="posTaxRateDisplay">0</span>%): <span id="posTaxAmount">0.00</span></h4>
                            <h3>ุงูุฅุฌูุงูู ุงูููู: <span id="posTotalAmount">0.00</span></h3>
                        </div>
                        <div class="form-group mt-1">
                            <label for="posPaymentMethod">ุทุฑููุฉ ุงูุฏูุน:</label>
                            <select id="posPaymentMethod">
                                <option value="cash">ููุฏุงู</option>
                                <option value="card">ุจุทุงูุฉ ุงุฆุชูุงู</option>
                                <option value="debt">ุขุฌู / ุฏูู</option>
                                <option value="online">ุฏูุน ุฅููุชุฑููู</option>
                                <option value="other">ุฃุฎุฑู</option>
                            </select>
                        </div>
                        <button id="completeSaleBtn" class="primary" style="width:100%; margin-top:10px; padding: 12px;"> <span class="icon">๐ณ</span> ุฅุชูุงู ุงูุจูุน ูุงูุฏูุน</button>
                        <button id="clearCartBtn" class="danger" style="width:100%; margin-top:10px;"> <span class="icon">๐๏ธ</span> ุฅูุฑุงุบ ุงูุณูุฉ</button>
                    </div>
                </div>
            </section>

            <!-- Products Page -->
            <section id="products" class="page">
                <div class="page-header">
                    <h1>ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</h1>
                    <button id="addProductBtn" class="primary"><span class="icon">โ</span> ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ</button>
                </div>
                <div class="table-responsive-wrapper">
                    <table id="productsTable">
                        <thead><tr><th>#</th><th>ุงูููุชุฌ</th><th>ุงููุฆุฉ</th><th>ุณุนุฑ ุงูุจูุน</th><th>ุชูููุฉ ุงูุดุฑุงุก</th><th>ุงููููุฉ</th><th>ุงููุญุฏุฉ</th><th>ุญุฏ ุงูุทูุจ</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Categories Page -->
            <section id="categories" class="page">
                <div class="page-header">
                    <h1>ูุฆุงุช ุงูููุชุฌุงุช</h1>
                    <button id="addCategoryBtn" class="primary"><span class="icon">โ</span> ุฅุถุงูุฉ ูุฆุฉ ุฌุฏูุฏุฉ</button>
                </div>
                <div class="table-responsive-wrapper">
                    <table id="categoriesTable">
                        <thead><tr><th>#</th><th>ุงุณู ุงููุฆุฉ</th><th>ุนุฏุฏ ุงูููุชุฌุงุช</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Inventory Page -->
            <section id="inventory" class="page">
                 <div class="page-header"><h1>ุฅุฏุงุฑุฉ ุงููุฎุฒูู</h1></div>
                <div class="table-responsive-wrapper">
                    <table id="inventoryTable">
                        <thead><tr><th>#</th><th>ุงูููุชุฌ</th><th>ุงููููุฉ ุงูุญุงููุฉ</th><th>ุงููุญุฏุฉ</th><th>ุญุฏ ุฅุนุงุฏุฉ ุงูุทูุจ</th><th>ุงูุญุงูุฉ</th><th>ูููุฉ ุงููุฎุฒูู (ุจุงูุชูููุฉ)</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Sales Page -->
            <section id="sales" class="page">
                <div class="page-header"><h1>ุงููุจูุนุงุช ูุงูุชูุงุฑูุฑ</h1></div>
                <div class="form-group d-flex align-center" style="gap: 10px; flex-wrap:wrap;">
                    <label for="reportDateRange" style="margin-bottom:0;">ูุทุงู ุงูุชุงุฑูุฎ:</label>
                    <input type="date" id="reportStartDate" style="width:auto; min-width: 130px;">
                    <span>ุฅูู</span>
                    <input type="date" id="reportEndDate" style="width:auto; min-width: 130px;">
                    <button id="generateReportBtn" class="small primary"><span class="icon">๐</span> ุนุฑุถ ุงูุชูุฑูุฑ</button>
                    <button id="clearReportFilterBtn" class="small"><span class="icon">โ</span> ูุณุญ ุงูููุชุฑ</button>
                </div>
                <div class="table-responsive-wrapper">
                    <table id="salesReportTable">
                        <thead><tr><th>ุฑูู ุงููุงุชูุฑุฉ</th><th>ุงูุชุงุฑูุฎ</th><th>ุงูุนููู</th><th>ุงูุฃุตูุงู</th><th>ุทุฑููุฉ ุงูุฏูุน</th><th>ุงูุฅุฌูุงูู</th><th>ุชูุงุตูู</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Customers Page -->
            <section id="customers" class="page">
                <div class="page-header">
                    <h1>ุฅุฏุงุฑุฉ ุงูุนููุงุก</h1>
                    <button id="addCustomerBtn" class="primary"><span class="icon">โ</span> ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ</button>
                </div>
                <div class="table-responsive-wrapper">
                    <table id="customersTable">
                        <thead><tr><th>#</th><th>ุงุณู ุงูุนููู</th><th>ุงููุงุชู</th><th>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</th><th>ุฅุฌูุงูู ุงููุดุชุฑูุงุช</th><th>ุงูุฏูู ุงูุญุงูู</th><th>ุขุฎุฑ ุนูููุฉ ุดุฑุงุก</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Customer Debts Page -->
            <section id="customerDebts" class="page">
                <div class="page-header">
                    <h1>ุฏููู ุงูุนููุงุก</h1>
                </div>
                <div class="table-responsive-wrapper">
                    <table id="customerDebtsTable">
                        <thead>
                            <tr>
                                <th>ุงุณู ุงูุนููู</th>
                                <th>ุฅุฌูุงูู ุงูุฏูู</th>
                                <th>ุขุฎุฑ ุชุญุฏูุซ ููุฏูู</th>
                                <th>ุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Suppliers Page -->
            <section id="suppliers" class="page">
                <div class="page-header">
                    <h1>ุฅุฏุงุฑุฉ ุงูููุฑุฏูู</h1>
                    <button id="addSupplierBtn" class="primary"><span class="icon">โ</span> ุฅุถุงูุฉ ููุฑุฏ ุฌุฏูุฏ</button>
                </div>
                <div class="table-responsive-wrapper">
                    <table id="suppliersTable">
                        <thead><tr><th>#</th><th>ุงุณู ุงูููุฑุฏ</th><th>ุงููุงุชู</th><th>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</th><th>ุงูุนููุงู</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Purchase Orders Page -->
            <section id="purchaseOrders" class="page">
                <div class="page-header">
                    <h1>ุทูุจุงุช ุงูุดุฑุงุก</h1>
                    <button id="addPurchaseOrderBtn" class="primary"><span class="icon">โ</span> ุฅูุดุงุก ุทูุจ ุดุฑุงุก ุฌุฏูุฏ</button>
                </div>
                <div class="table-responsive-wrapper">
                    <table id="purchaseOrdersTable">
                        <thead><tr><th>ุฑูู ุงูุทูุจ</th><th>ุงูููุฑุฏ</th><th>ุชุงุฑูุฎ ุงูุทูุจ</th><th>ุชุงุฑูุฎ ุงูุงุณุชูุงู ุงููุชููุน</th><th>ุงูุญุงูุฉ</th><th>ุงูุฅุฌูุงูู</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Quotations Page -->
            <section id="quotations" class="page">
                <div class="page-header">
                    <h1>ุนุฑูุถ ุงูุฃุณุนุงุฑ / ุงูููุงุชูุฑ ุงูุฃูููุฉ</h1>
                    <button id="addQuotationBtn" class="primary"><span class="icon">โ</span> ุฅูุดุงุก ุนุฑุถ ุณุนุฑ ุฌุฏูุฏ</button>
                </div>
                <div class="table-responsive-wrapper">
                    <table id="quotationsTable">
                        <thead><tr><th>ุฑูู ุงูุนุฑุถ</th><th>ุงูุนููู</th><th>ุงูุชุงุฑูุฎ</th><th>ุงูุญุงูุฉ</th><th>ุงูุฅุฌูุงูู</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Expenses Page -->
            <section id="expenses" class="page">
                <div class="page-header">
                    <h1>ุฅุฏุงุฑุฉ ุงููุตุฑููุงุช</h1>
                    <button id="addExpenseBtn" class="primary"><span class="icon">โ</span> ุฅุถุงูุฉ ูุตุฑูู ุฌุฏูุฏ</button>
                </div>
                 <div class="form-group d-flex align-center" style="gap: 10px; flex-wrap:wrap;">
                    <label for="expenseDateRange" style="margin-bottom:0;">ูุทุงู ุงูุชุงุฑูุฎ:</label>
                    <input type="date" id="expenseStartDate" style="width:auto; min-width: 130px;">
                    <span>ุฅูู</span>
                    <input type="date" id="expenseEndDate" style="width:auto; min-width: 130px;">
                    <button id="filterExpensesBtn" class="small primary"><span class="icon">๐</span> ุนุฑุถ</button>
                     <button id="clearExpenseFilterBtn" class="small"><span class="icon">โ</span> ูุณุญ ุงูููุชุฑ</button>
                </div>
                <div class="table-responsive-wrapper">
                    <table id="expensesTable">
                        <thead><tr><th>#</th><th>ุงูุชุงุฑูุฎ</th><th>ุงููุตู/ุงูุจูุฏ</th><th>ุงููุฆุฉ</th><th>ุงููุจูุบ</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div style="text-align:left; margin-top:15px;">
                    <h3>ุฅุฌูุงูู ุงููุตุฑููุงุช ูููุชุฑุฉ ุงููุญุฏุฏุฉ: <span id="totalFilteredExpenses">0.00</span></h3>
                </div>
            </section>

            <!-- Settings Page -->
            <section id="settings" class="page">
                <div class="page-header"><h1>ุงูุฅุนุฏุงุฏุงุช</h1></div>
                <div class="settings-section">
                    <h3>ุฅุนุฏุงุฏุงุช ุนุงูุฉ ูููุญู</h3>
                    <div class="form-group">
                        <label for="settingStoreName">ุงุณู ุงููุญู:</label>
                        <input type="text" id="settingStoreName" placeholder="ุฃุฏุฎู ุงุณู ุงููุญู">
                    </div>
                    <div class="form-group">
                        <label for="settingStoreAddress">ุนููุงู ุงููุญู:</label>
                        <input type="text" id="settingStoreAddress" placeholder="ุฃุฏุฎู ุนููุงู ุงููุญู">
                    </div>
                    <div class="form-group">
                        <label for="settingStorePhone">ูุงุชู ุงููุญู:</label>
                        <input type="tel" id="settingStorePhone" placeholder="ุฃุฏุฎู ูุงุชู ุงููุญู">
                    </div>
                    <div class="form-group">
                        <label for="settingStoreEmail">ุจุฑูุฏ ุงููุญู ุงูุฅููุชุฑููู:</label>
                        <input type="email" id="settingStoreEmail" placeholder="ุฃุฏุฎู ุจุฑูุฏ ุงููุญู">
                    </div>
                    <div class="form-group">
                        <label for="settingStoreLogoUrl">ุฑุงุจุท ุดุนุงุฑ ุงููุญู (URL):</label>
                        <input type="text" id="settingStoreLogoUrl" placeholder="https://example.com/logo.png">
                    </div>
                </div>
                <hr class="mt-2 mb-2">
                <div class="settings-section">
                    <h3>ุฅุนุฏุงุฏุงุช ุงูุนููุฉ ูุงูุถุฑูุจุฉ</h3>
                    <div class="form-group">
                        <label for="currencySelect">ุงุฎุชุฑ ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ:</label>
                        <select id="currencySelect"></select>
                    </div>
                    <div class="form-group">
                        <label for="taxRateInput">ูุนุฏู ุงูุถุฑูุจุฉ (ูุซุงู: 0.15 ูู 15%):</label>
                        <input type="number" id="taxRateInput" step="0.001" min="0" max="1">
                    </div>
                </div>
                 <button id="saveSettingsBtn" class="primary mt-2"><span class="icon">๐พ</span> ุญูุธ ุงูุฅุนุฏุงุฏุงุช</button>
                <hr class="mt-2 mb-2">
                <div class="settings-section">
                    <h3>ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชุนุงุฏุฉ</h3>
                    <p>ูู ุงูุถุฑูุฑู ุนูู ูุณุฎ ุงุญุชูุงุทูุฉ ูุจูุงูุงุชู ุจุงูุชุธุงู.</p>
                    <div class="form-group mt-1">
                        <button id="backupDataBtn" class="info"><span class="icon">๐ค</span> ุชุตุฏูุฑ ุงูุจูุงูุงุช (ูุณุฎ ุงุญุชูุงุทู)</button>
                    </div>
                    <div class="form-group">
                        <label for="restoreDataFile">ุงุฎุชุฑ ููู ุงููุณุฎ ุงูุงุญุชูุงุทู (JSON) ููุงุณุชุนุงุฏุฉ:</label>
                        <input type="file" id="restoreDataFile" accept=".json" style="padding: 10px; border: 1px solid var(--medium-gray); border-radius: 4px; width:100%;">
                        <button id="restoreDataBtn" class="warning mt-1"><span class="icon">๐ฅ</span> ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช (ุงุณุชุนุงุฏุฉ)</button>
                        <p class="text-danger mt-1"><small>ุชุญุฐูุฑ: ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุณูููู ุจุงููุชุงุจุฉ ููู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ.</small></p>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Generic Modal Structure -->
    <div id="formModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ุนููุงู ุงููุงูุฐุฉ</h3>
                <span class="close-button" data-modal-id="formModal">ร</span>
            </div>
            <form id="genericForm">
            </form>
        </div>
    </div>

    <!-- View Sale Details Modal -->
    <div id="saleDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ุชูุงุตูู ุงููุงุชูุฑุฉ ุฑูู: <span id="detailsSaleId"></span></h3>
                <span class="close-button" data-modal-id="saleDetailsModal">ร</span>
            </div>
            <p><strong>ุงูุชุงุฑูุฎ:</strong> <span id="detailsSaleDate"></span></p>
            <p><strong>ุงูุนููู:</strong> <span id="detailsSaleCustomer"></span></p>
            <p><strong>ุทุฑููุฉ ุงูุฏูุน:</strong> <span id="detailsSalePaymentMethod"></span></p>
            <h4>ุงูุฃุตูุงู:</h4>
            <div class="table-responsive-wrapper">
                <table id="detailsSaleItemsTable">
                    <thead><tr><th>ุงูููุชุฌ</th><th>ุงููููุฉ</th><th>ุงูุณุนุฑ</th><th>ุงูุฅุฌูุงูู ุงููุฑุนู</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
             <hr class="mt-2 mb-2">
            <div style="text-align: left;">
                <p><strong>ุงูุฅุฌูุงูู ุงููุฑุนู:</strong> <span id="detailsSaleSubtotal"></span></p>
                <p><strong>ุงูุถุฑูุจุฉ:</strong> <span id="detailsSaleTax"></span></p>
                <p><strong>ุงูุฅุฌูุงูู ุงูููู:</strong> <span id="detailsSaleTotal"></span></p>
            </div>
            <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap:10px;" class="no-print">
                <button class="primary small" onclick="handlePrintInvoice(document.getElementById('saleDetailsModal').dataset.currentSaleIdForActions || '')"><span class="icon">๐จ๏ธ</span> ุทุจุงุนุฉ</button>
            </div>
        </div>
    </div>

    <!-- Sale Confirmation & Invoice Options Modal -->
    <div id="saleConfirmationModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 id="saleConfirmationTitle">ุชู ุงูุจูุน ุจูุฌุงุญ!</h3>
                <span class="close-button" data-modal-id="saleConfirmationModal">ร</span>
            </div>
            <div id="saleConfirmationBody" style="padding: 15px 0;">
                <p>ุฑูู ุงููุงุชูุฑุฉ: <strong id="confirmSaleId"></strong></p>
                <p>ุงูุฅุฌูุงูู: <strong id="confirmSaleTotal"></strong></p>
                <hr>
                <p>ุฎูุงุฑุงุช ุงููุงุชูุฑุฉ:</p>
                <div style="margin-top: 15px; display: flex; justify-content: space-around; flex-wrap:wrap; gap:10px;">
                    <button id="printInvoiceBtn" class="primary"><span class="icon">๐จ๏ธ</span> ุทุจุงุนุฉ ุงููุงุชูุฑุฉ</button>
                    <button id="emailInvoiceBtn"><span class="icon">๐ง</span> ุฅุฑุณุงู ุนุจุฑ ุงูุจุฑูุฏ</button>
                </div>
                <div class="form-group mt-2" id="emailInvoiceInputGroup" style="display:none;">
                    <label for="customerEmailForInvoice">ุจุฑูุฏ ุงูุนููู ุงูุฅููุชุฑููู:</label>
                    <input type="email" id="customerEmailForInvoice" placeholder="ุฃุฏุฎู ุจุฑูุฏ ุงูุนููู">
                    <button id="sendEmailConfirmBtn" class="small primary mt-1">ุฅุฑุณุงู</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="confirmModalTitle">ุชุฃููุฏ ุงูุฅุฌุฑุงุก</h3>
                <span class="close-button" data-modal-id="confirmModal">ร</span>
            </div>
            <div class="modal-body" style="padding: 15px 0;">
                <p id="confirmModalMessage">ูู ุฃูุช ูุชุฃูุฏ ุฃูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ</p>
            </div>
            <div class="modal-footer" style="text-align: left; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                <button id="confirmModalYesBtn" class="danger">ูุนู</button>
                <button id="confirmModalNoBtn" class="primary" style="margin-right: 5px;">ูุง</button>
            </div>
        </div>
    </div>
    
    <!-- Debt Payment Modal -->
    <div id="debtPaymentModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3>ุชุณุฏูุฏ ุฏูุนุฉ ุฏูู</h3>
                <span class="close-button" data-modal-id="debtPaymentModal">ร</span>
            </div>
            <form id="debtPaymentForm">
                <p>ุงูุนููู: <strong id="debtPaymentCustomerName"></strong></p>
                <p>ุงูุฏูู ุงูุญุงูู: <strong id="debtPaymentCurrentDebt"></strong></p>
                <div class="form-group mt-2">
                    <label for="debtPaymentAmount">ูุจูุบ ุงูุฏูุนุฉ:</label>
                    <input type="number" id="debtPaymentAmount" name="amount" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="debtPaymentDate">ุชุงุฑูุฎ ุงูุฏูุนุฉ:</label>
                    <input type="date" id="debtPaymentDate" name="date" required>
                </div>
                <button type="submit" class="primary mt-2"><span class="icon">๐ฐ</span> ุชุณุฌูู ุงูุฏูุนุฉ</button>
            </form>
        </div>
    </div>


    <!-- Purchase Order Modal -->
    <div id="purchaseOrderModal" class="modal">
        <div class="modal-content" style="max-width: 750px;"> <!-- Increased width for PO -->
            <div class="modal-header">
                <h3 id="purchaseOrderModalTitle">ุฅูุดุงุก ุทูุจ ุดุฑุงุก</h3>
                <span class="close-button" data-modal-id="purchaseOrderModal">ร</span>
            </div>
            <form id="purchaseOrderForm">
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="poSupplierSelect">ุงุฎุชุฑ ุงูููุฑุฏ:</label>
                        <select id="poSupplierSelect" name="supplierId" required></select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="poExpectedDate">ุชุงุฑูุฎ ุงูุงุณุชูุงู ุงููุชููุน:</label>
                        <input type="date" id="poExpectedDate" name="expectedDate">
                    </div>
                </div>
                <hr>
                <h4>ุฃุตูุงู ุงูุทูุจ:</h4>
                <div class="form-group">
                    <label for="poProductSearch">ุจุญุซ ูุฅุถุงูุฉ ููุชุฌ ููุทูุจ:</label>
                    <input type="text" id="poProductSearch" placeholder="ุงุจุญุซ ุจุงูุงุณู ุฃู ุงูููุฏ">
                    <div id="poProductSearchResultsList" style="border: 1px solid var(--medium-gray); max-height: 100px; overflow-y: auto; background: var(--white); border-radius: 4px; margin-top: 5px;">
                    </div>
                </div>
                <div class="table-responsive-wrapper">
                    <table id="poItemsTable" class="mt-1">
                        <thead>
                            <tr>
                                <th>ุงูููุชุฌ</th>
                                <th>ุงููููุฉ ุงููุทููุจุฉ</th>
                                <th>ุชูููุฉ ุงููุญุฏุฉ</th>
                                <th>ุงูุฅุฌูุงูู ุงููุฑุนู</th>
                                <th>ุฅุฌุฑุงุก</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <div style="text-align: left; margin-top: 15px;">
                    <h4>ุฅุฌูุงูู ุงูุทูุจ: <span id="poTotalAmount">0.00</span></h4>
                </div>
                 <div class="form-group">
                    <label for="poNotes">ููุงุญุธุงุช (ุงุฎุชูุงุฑู):</label>
                    <textarea id="poNotes" name="notes" placeholder="ุฃู ููุงุญุธุงุช ุฅุถุงููุฉ ุฎุงุตุฉ ุจุงูุทูุจ"></textarea>
                </div>
                <button type="submit" class="primary mt-2"><span class="icon">๐พ</span> ุญูุธ ุทูุจ ุงูุดุฑุงุก</button>
            </form>
        </div>
    </div>
    
    <!-- Quotation Modal -->
    <div id="quotationModal" class="modal">
        <div class="modal-content" style="max-width: 750px;">
            <div class="modal-header">
                <h3 id="quotationModalTitle">ุฅูุดุงุก ุนุฑุถ ุณุนุฑ / ูุงุชูุฑุฉ ุฃูููุฉ</h3>
                <span class="close-button" data-modal-id="quotationModal">ร</span>
            </div>
            <form id="quotationForm">
                <div class="form-group">
                    <label for="quoteCustomerSelect">ุงุฎุชุฑ ุงูุนููู:</label>
                    <select id="quoteCustomerSelect" name="customerId" required></select>
                </div>
                <hr>
                <h4>ุฃุตูุงู ุนุฑุถ ุงูุณุนุฑ:</h4>
                <div class="form-group">
                    <label for="quoteProductSearch">ุจุญุซ ูุฅุถุงูุฉ ููุชุฌ ููุนุฑุถ:</label>
                    <input type="text" id="quoteProductSearch" placeholder="ุงุจุญุซ ุจุงูุงุณู ุฃู ุงูููุฏ">
                    <div id="quoteProductSearchResultsList" style="border: 1px solid var(--medium-gray); max-height: 100px; overflow-y: auto; background: var(--white); border-radius: 4px; margin-top: 5px;"></div>
                </div>
                <div class="table-responsive-wrapper">
                    <table id="quoteItemsTable" class="mt-1">
                        <thead>
                            <tr><th>ุงูููุชุฌ</th><th>ุงููููุฉ</th><th>ุณุนุฑ ุงููุญุฏุฉ</th><th>ุงูุฅุฌูุงูู ุงููุฑุนู</th><th>ุฅุฌุฑุงุก</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div style="text-align: left; margin-top: 15px;">
                    <h4>ุงูุฅุฌูุงูู ุงููุฑุนู: <span id="quoteSubtotalAmount">0.00</span></h4>
                    <h4>ุงูุถุฑูุจุฉ (<span id="quoteTaxRateDisplay">0</span>%): <span id="quoteTaxAmount">0.00</span></h4>
                    <h3>ุฅุฌูุงูู ุงูุนุฑุถ: <span id="quoteTotalAmount">0.00</span></h3>
                </div>
                 <div class="form-group">
                    <label for="quoteNotes">ููุงุญุธุงุช (ุงุฎุชูุงุฑู):</label>
                    <textarea id="quoteNotes" name="notes" placeholder="ุดุฑูุท ูุฃุญูุงูุ ูุฏุฉ ุตูุงุญูุฉ ุงูุนุฑุถุ ุฅูุฎ."></textarea>
                </div>
                <button type="submit" class="primary mt-2"><span class="icon">๐พ</span> ุญูุธ ุนุฑุถ ุงูุณุนุฑ</button>
            </form>
        </div>
    </div>

    <!-- View Purchase Order/Quotation Details Modal -->
    <div id="viewDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="viewDetailsTitle"></h3>
                <span class="close-button" data-modal-id="viewDetailsModal">ร</span>
            </div>
            <div id="viewDetailsBody" style="padding: 10px 0;">
                <!-- Details will be injected here -->
            </div>
             <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap:10px;" class="no-print" id="viewDetailsActions">
                 <!-- Actions like print PO/Quote can be added here -->
            </div>
        </div>
    </div>


    <!-- Hidden div for printing content. MUST be a direct child of <body> for print styles to work reliably -->
    <div id="invoiceToPrint" style="display: none;"></div>

<script>
    // --- Polyfill for structuredClone ---
    if (typeof self.structuredClone === 'undefined') {
        self.structuredClone = (obj) => JSON.parse(JSON.stringify(obj));
    }

    // --- Application State & LocalStorage ---
    const APP_PREFIX = 'proStoreManager_v8_'; // Increment version for new features
    let state = {};

    const currencies = [
        { code: "DZD", symbol: "ุฏ.ุฌ", name: "ุงูุฏููุงุฑ ุงูุฌุฒุงุฆุฑู (DZD)" }, { code: "MAD", symbol: "ุฏ.ู.", name: "ุงูุฏุฑูู ุงููุบุฑุจู (MAD)" },
        { code: "TND", symbol: "ุฏ.ุช", name: "ุงูุฏููุงุฑ ุงูุชููุณู (TND)" }, { code: "LYD", symbol: "ู.ุฏ", name: "ุงูุฏููุงุฑ ุงูููุจู (LYD)" },
        { code: "SAR", symbol: "ุฑ.ุณ", name: "ุงูุฑูุงู ุงูุณุนูุฏู (SAR)" }, { code: "AED", symbol: "ุฏ.ุฅ", name: "ุงูุฏุฑูู ุงูุฅูุงุฑุงุชู (AED)" },
        { code: "USD", symbol: "$", name: "ุงูุฏููุงุฑ ุงูุฃูุฑููู (USD)" }, { code: "EUR", symbol: "โฌ", name: "ุงูููุฑู (EUR)" },
    ];
    
    const productUnits = [
        { key: 'unit', name: 'ูุญุฏุฉ' }, { key: 'piece', name: 'ูุทุนุฉ' }, { key: 'kg', name: 'ูููู ุฌุฑุงู' }, { key: 'g', name: 'ุฌุฑุงู' },
        { key: 'l', name: 'ูุชุฑ' }, { key: 'ml', name: 'ููููุชุฑ' }, { key: 'm', name: 'ูุชุฑ' }
    ];

    function loadState() {
        const storedState = localStorage.getItem(APP_PREFIX + 'appState');
        const defaultStateStructure = {
            products: [], categories: [], customers: [], sales: [], currentCart: [],
            suppliers: [], purchaseOrders: [], expenses: [], quotations: [],
            currency: currencies.find(c => c.code === "DZD") || currencies[0],
            taxRate: 0.19,
            storeDetails: { name: "ุงุณู ุงููุญู ุงูุชุฌุงุฑู", address: "ุงูุนููุงูุ ุงููุฏููุฉุ ุงูุฏููุฉ", phone: "000-000-0000", email: "store@example.com", logoUrl: ""}
        };

        if (storedState) {
            const parsedState = JSON.parse(storedState);
            state = { ...defaultStateStructure, ...parsedState };
            // Deep merge nested objects to ensure new keys in default structure are added
            state.currency = { ...defaultStateStructure.currency, ...(parsedState.currency || {}) };
            state.storeDetails = { ...defaultStateStructure.storeDetails, ...(parsedState.storeDetails || {}) };
            
            // Re-hydrate Date objects from string representations and ensure data integrity for older versions
            state.sales = (parsedState.sales || []).map(sale => ({ ...sale, date: new Date(sale.date) }));
            state.purchaseOrders = (parsedState.purchaseOrders || []).map(po => ({...po, date: new Date(po.date), expectedDate: po.expectedDate ? new Date(po.expectedDate) : null, receivedDate: po.receivedDate ? new Date(po.receivedDate) : null }));
            state.expenses = (parsedState.expenses || []).map(exp => ({...exp, date: new Date(exp.date) }));
            state.quotations = (parsedState.quotations || []).map(q => ({...q, date: new Date(q.date) }));
            
            // Ensure data integrity for older versions
            state.products = (parsedState.products || []).map(p => ({ ...p, costPrice: p.costPrice || 0, unit: p.unit || 'unit' }));
            state.customers = (parsedState.customers || []).map(c => ({ ...c, debt: c.debt || 0, debtHistory: c.debtHistory || [] }));
            state.suppliers = parsedState.suppliers || [];

        } else {
            state = { ...defaultStateStructure };
            initializeDefaultData();
        }
        updateCurrencyDisplayElements();
        updateTaxRateDisplayElements();
    }

    function saveState() {
        localStorage.setItem(APP_PREFIX + 'appState', JSON.stringify(state));
    }

    function initializeDefaultData() {
        if (state.categories.length === 0) {
            state.categories = [ { id: generateId(), name: 'ุฅููุชุฑูููุงุช' }, { id: generateId(), name: 'ููุงุจุณ' }, { id: generateId(), name: 'ุฃุบุฐูุฉ' }];
        }
        if(state.suppliers.length === 0){
            state.suppliers.push({id: generateId(), name: "ููุฑุฏ ุนุงู", phone: "-", email: "-", address: "-"});
        }
        saveState();
    }

    function generateId() { return '_' + Math.random().toString(36).substr(2, 9); }
    function formatDate(dateInput) {
        if (!dateInput) return '-';
        const date = new Date(dateInput);
        if (isNaN(date)) return '-';
        return date.toLocaleString('ar-EG', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }
    function formatDateForInput(dateInput) {
        if (!dateInput) return '';
        const d = new Date(dateInput);
        if (isNaN(d)) return '';
        let month = '' + (d.getMonth() + 1);
        let day = '' + d.getDate();
        const year = d.getFullYear();
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        return [year, month, day].join('-');
    }

    function formatCurrency(amount) {
        if (isNaN(parseFloat(amount))) return `0.00 ${state.currency.symbol || state.currency.code}`;
        return `${parseFloat(amount).toFixed(2)} ${state.currency.symbol || state.currency.code}`;
    }

    const navLinks = document.querySelectorAll('.nav-link');
    const pages = document.querySelectorAll('.page');
    const formModalElement = document.getElementById('formModal');
    const saleDetailsModalElement = document.getElementById('saleDetailsModal');
    const saleConfirmationModalElement = document.getElementById('saleConfirmationModal');
    const confirmModalElement = document.getElementById('confirmModal');
    const purchaseOrderModalElement = document.getElementById('purchaseOrderModal');
    const debtPaymentModalElement = document.getElementById('debtPaymentModal');
    const quotationModalElement = document.getElementById('quotationModal');
    const viewDetailsModalElement = document.getElementById('viewDetailsModal');

    const modalTitleElement = document.getElementById('modalTitle');
    const genericFormElement = document.getElementById('genericForm');

    function showPage(pageId) {
        pages.forEach(page => page.classList.remove('active'));
        navLinks.forEach(link => link.classList.remove('active'));
        document.getElementById(pageId)?.classList.add('active');
        document.querySelector(`.nav-link[data-page="${pageId}"]`)?.classList.add('active');

        switch (pageId) {
            case 'dashboard': renderDashboard(); break;
            case 'products': renderProductsTable(); break;
            case 'categories': renderCategoriesTable(); break;
            case 'inventory': renderInventoryTable(); break;
            case 'pos': renderPosPage(); break;
            case 'sales': renderSalesReport(); break;
            case 'customers': renderCustomersTable(); break;
            case 'customerDebts': renderCustomerDebtsPage(); break;
            case 'suppliers': renderSuppliersTable(); break;
            case 'purchaseOrders': renderPurchaseOrdersTable(); break;
            case 'quotations': renderQuotationsTable(); break;
            case 'expenses': renderExpensesTable(); break;
            case 'settings': renderSettingsPage(); break;
        }
    }

    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const pageId = e.target.closest('a')?.dataset.page;
            if (pageId) showPage(pageId);
        });
    });

    function openModal(modalElement) { if (modalElement) modalElement.style.display = 'block'; }
    function closeModal(modalElement) {
        if (!modalElement) return;
        modalElement.style.display = 'none';
        // Reset specific forms or content on close
        if (modalElement === formModalElement) {
            genericFormElement.innerHTML = '';
            genericFormElement.onsubmit = null;
        }
        if (modalElement === purchaseOrderModalElement) {
            document.getElementById('purchaseOrderForm').reset();
            document.querySelector('#poItemsTable tbody').innerHTML = '';
            document.getElementById('poTotalAmount').textContent = formatCurrency(0);
            document.getElementById('poProductSearchResultsList').innerHTML = '';
            if(purchaseOrderModalElement.dataset.editId) delete purchaseOrderModalElement.dataset.editId;
        }
        if (modalElement === quotationModalElement) {
            document.getElementById('quotationForm').reset();
            document.querySelector('#quoteItemsTable tbody').innerHTML = '';
            document.getElementById('quoteTotalAmount').textContent = formatCurrency(0);
            document.getElementById('quoteProductSearchResultsList').innerHTML = '';
            if(quotationModalElement.dataset.editId) delete quotationModalElement.dataset.editId;
        }
        if(modalElement === debtPaymentModalElement) {
            document.getElementById('debtPaymentForm').reset();
        }
    }

    document.querySelectorAll('.close-button').forEach(btn => {
        btn.addEventListener('click', () => closeModal(document.getElementById(btn.dataset.modalId)));
    });
    window.onclick = (event) => {
        if (event.target.classList.contains('modal')) closeModal(event.target);
    }

    let toastTimeout;
    function showToast(message, type = 'success', duration = 3000) {
        const existingToast = document.querySelector('.toast');
        if (existingToast) { existingToast.remove(); clearTimeout(toastTimeout); }
        const toast = document.createElement('div');
        toast.className = `toast ${type}`; toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        toastTimeout = setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    function showConfirmModal(message, onConfirm, title = "ุชุฃููุฏ ุงูุฅุฌุฑุงุก") {
        if (!confirmModalElement) return;
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalMessage').textContent = message;
        const yesBtn = document.getElementById('confirmModalYesBtn');
        const noBtn = document.getElementById('confirmModalNoBtn');
        const newYesBtn = yesBtn.cloneNode(true);
        yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
        newYesBtn.onclick = () => { onConfirm(); closeModal(confirmModalElement); };
        noBtn.onclick = () => closeModal(confirmModalElement);
        openModal(confirmModalElement);
    }

    function buildForm(fields, data = {}, submitHandler, modalTitleText, formIdToClear = 'genericForm') {
        modalTitleElement.textContent = modalTitleText;
        const formElement = document.getElementById(formIdToClear);
        if (!formElement) { console.error("Form element not found:", formIdToClear); return; }
        formElement.innerHTML = '';

        fields.forEach(field => {
            const group = document.createElement('div'); group.className = 'form-group';
            const label = document.createElement('label'); label.htmlFor = field.id; label.textContent = field.label;
            group.appendChild(label);

            if (field.type === 'select') {
                const select = document.createElement('select');
                select.id = field.id; select.name = field.name; if (field.required) select.required = true;
                (field.options || []).forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value; option.textContent = opt.text;
                    if (data[field.name] == opt.value) option.selected = true;
                    select.appendChild(option);
                });
                group.appendChild(select);
            } else if (field.type === 'textarea') {
                const textarea = document.createElement('textarea');
                textarea.id = field.id; textarea.name = field.name; textarea.value = data[field.name] || '';
                if (field.required) textarea.required = true; if (field.placeholder) textarea.placeholder = field.placeholder;
                group.appendChild(textarea);
            } else {
                const input = document.createElement('input');
                input.type = field.type; input.id = field.id; input.name = field.name;
                if (field.type === 'date' && data[field.name]) {
                    input.value = formatDateForInput(data[field.name]);
                } else {
                    input.value = data[field.name] || (field.type === 'number' && field.min !== undefined ? field.min : (field.type === 'number' ? 0 : ''));
                }
                if (field.type === 'number') {
                    if (field.step) input.step = field.step;
                    if (field.min !== undefined) input.min = field.min;
                }
                if (field.required) input.required = true; if (field.placeholder) input.placeholder = field.placeholder;
                group.appendChild(input);
            }
            formElement.appendChild(group);
        });

        const submitButton = document.createElement('button');
        submitButton.type = 'submit';
        submitButton.className = 'primary';
        submitButton.innerHTML = `<span class="icon">๐พ</span> ${data.id ? 'ุชุญุฏูุซ' : 'ุญูุธ'}`;
        formElement.appendChild(submitButton);

        formElement.onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(formElement);
            const itemData = Object.fromEntries(formData.entries());
            fields.forEach(field => {
                if (field.type === 'number' && itemData[field.name] !== '') {
                    itemData[field.name] = parseFloat(itemData[field.name]);
                } else if (field.type === 'number' && itemData[field.name] === '') {
                    itemData[field.name] = field.min !== undefined ? field.min : 0;
                } else if (field.type === 'date' && itemData[field.name]) {
                    const [year, month, day] = itemData[field.name].split('-').map(Number);
                    itemData[field.name] = new Date(Date.UTC(year, month - 1, day)).toISOString();
                }
            });
            if (data.id) itemData.id = data.id;
            submitHandler(itemData);
            if (formElement.closest('.modal')) closeModal(formElement.closest('.modal'));
        };
        if (formElement.closest('.modal') === formModalElement) openModal(formModalElement);
    }
    
    function getUnitName(key) {
        const unit = productUnits.find(u => u.key === key);
        return unit ? unit.name : key;
    }

    // --- Settings Page ---
    function renderSettingsPage() {
        populateCurrencySelect();
        document.getElementById('taxRateInput').value = state.taxRate;
        document.getElementById('settingStoreName').value = state.storeDetails.name;
        document.getElementById('settingStoreAddress').value = state.storeDetails.address;
        document.getElementById('settingStorePhone').value = state.storeDetails.phone;
        document.getElementById('settingStoreEmail').value = state.storeDetails.email;
        document.getElementById('settingStoreLogoUrl').value = state.storeDetails.logoUrl;
    }
    
    function populateCurrencySelect() {
        const currencySelect = document.getElementById('currencySelect');
        if (!currencySelect) return;
        currencySelect.innerHTML = '';
        currencies.forEach(curr => {
            const option = document.createElement('option');
            option.value = curr.code; option.textContent = curr.name;
            if (state.currency && state.currency.code === curr.code) option.selected = true;
            currencySelect.appendChild(option);
        });
    }

    document.getElementById('saveSettingsBtn')?.addEventListener('click', () => {
        const currencySelect = document.getElementById('currencySelect');
        const taxRateInput = document.getElementById('taxRateInput');
        
        const selectedCurrencyObject = currencies.find(c => c.code === currencySelect.value);
        if (selectedCurrencyObject) state.currency = selectedCurrencyObject;
        
        const newTaxRate = parseFloat(taxRateInput.value);
        if (!isNaN(newTaxRate) && newTaxRate >= 0 && newTaxRate <= 1) {
            state.taxRate = newTaxRate;
        } else {
            showToast('ูุนุฏู ุงูุถุฑูุจุฉ ุบูุฑ ุตุงูุญ.', 'error'); taxRateInput.value = state.taxRate;
        }
        
        state.storeDetails = {
            name: document.getElementById('settingStoreName').value.trim(),
            address: document.getElementById('settingStoreAddress').value.trim(),
            phone: document.getElementById('settingStorePhone').value.trim(),
            email: document.getElementById('settingStoreEmail').value.trim(),
            logoUrl: document.getElementById('settingStoreLogoUrl').value.trim()
        };
        saveState(); showToast('ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช!', 'success');
        updateCurrencyDisplayElements(); updateTaxRateDisplayElements();
        const activePageId = document.querySelector('.page.active')?.id || 'dashboard';
        showPage(activePageId);
    });

    document.getElementById('backupDataBtn')?.addEventListener('click', () => {
        try {
            const filename = `store_backup_${formatDateForInput(new Date())}.json`;
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const linkElement = document.createElement('a');
            linkElement.href = url; linkElement.download = filename;
            document.body.appendChild(linkElement);
            linkElement.click();
            document.body.removeChild(linkElement);
            URL.revokeObjectURL(url);
            showToast('ุชู ุชุตุฏูุฑ ุงูุจูุงูุงุช ุจูุฌุงุญ!', 'success');
        } catch (error) { console.error("Backup error:", error); showToast('ุฎุทุฃ ูู ุชุตุฏูุฑ ุงูุจูุงูุงุช.', 'error'); }
    });
    
    document.getElementById('restoreDataBtn')?.addEventListener('click', () => {
        const restoreDataFile = document.getElementById('restoreDataFile');
        if (restoreDataFile.files.length === 0) { showToast('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููู ุงููุณุฎ ุงูุงุญุชูุงุทู ุฃููุงู.', 'info'); return; }
        const file = restoreDataFile.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importedState = JSON.parse(event.target.result);
                showConfirmModal('ูู ุฃูุช ูุชุฃูุฏ ูู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุชุ ุณูุชู ุงุณุชุจุฏุงู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ ุจุดูู ุฏุงุฆู.', () => {
                    localStorage.setItem(APP_PREFIX + 'appState', JSON.stringify(importedState));
                    showToast('ุชู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ! ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุชุทุจูู ุงูุชุบููุฑุงุช.', 'success', 5000);
                    setTimeout(() => window.location.reload(), 2000);
                }, 'ุชุฃููุฏ ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช');
            } catch (error) { console.error("Restore error:", error); showToast('ููู ุบูุฑ ุตุงูุญ ุฃู ุชุงูู.', 'error');
            } finally { restoreDataFile.value = ''; }
        };
        reader.readAsText(file);
    });

    function updateCurrencyDisplayElements() {
        if (document.getElementById('pos').classList.contains('active')) renderPosCart();
    }
    function updateTaxRateDisplayElements() {
        const taxRateDisplays = document.querySelectorAll('#posTaxRateDisplay, #quoteTaxRateDisplay');
        taxRateDisplays.forEach(el => {
            if (el) el.textContent = (state.taxRate * 100).toFixed(0);
        });
        if (document.getElementById('settings').classList.contains('active')) document.getElementById('taxRateInput').value = state.taxRate;
        if (document.getElementById('pos').classList.contains('active')) renderPosCart();
        if (document.getElementById('quotations').classList.contains('active')) {
             if (currentQuoteItems) renderQuoteItemsTable();
        }
    }

    // --- Categories Management ---
    if(document.getElementById('addCategoryBtn')) {
        document.getElementById('addCategoryBtn').addEventListener('click', () => {
            buildForm([{ id: 'categoryName', name: 'name', label: 'ุงุณู ุงููุฆุฉ:', type: 'text', required: true }], {}, handleSaveCategory, 'ุฅุถุงูุฉ ูุฆุฉ ุฌุฏูุฏุฉ');
        });
    }
    function handleSaveCategory(categoryData) {
        if (categoryData.id) {
            const index = state.categories.findIndex(c => c.id === categoryData.id);
            if (index !== -1) state.categories[index] = { ...state.categories[index], ...categoryData };
        } else { state.categories.push({ id: generateId(), ...categoryData }); }
        saveState(); renderCategoriesTable(); showToast(`ุชู ${categoryData.id ? 'ุชุญุฏูุซ' : 'ุญูุธ'} ุงููุฆุฉ!`);
    }
    function renderCategoriesTable() {
        const categoriesTableBody = document.querySelector('#categoriesTable tbody');
        if (!categoriesTableBody) return;
        categoriesTableBody.innerHTML = '';
        if (state.categories.length === 0) { categoriesTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ูุง ุชูุฌุฏ ูุฆุงุช.</td></tr>'; return; }
        state.categories.forEach((cat, index) => {
            const productCount = state.products.filter(p => p.categoryId === cat.id).length;
            const row = categoriesTableBody.insertRow();
            row.innerHTML = `<td>${index + 1}</td><td>${cat.name}</td><td>${productCount}</td>
                <td class="action-buttons">
                    <button class="small" onclick="editCategory('${cat.id}')"><span class="icon">โ๏ธ</span> ุชุนุฏูู</button>
                    <button class="small danger" onclick="confirmDeleteCategory('${cat.id}')"><span class="icon">๐๏ธ</span> ุญุฐู</button>
                </td>`;
        });
    }
    function editCategory(id) {
        const category = state.categories.find(c => c.id === id);
        if (category) buildForm([{ id: 'categoryName', name: 'name', label: 'ุงุณู ุงููุฆุฉ:', type: 'text', required: true }], category, handleSaveCategory, 'ุชุนุฏูู ุงููุฆุฉ');
    }
    function confirmDeleteCategory(id) {
        if (state.products.some(p => p.categoryId === id)) { showToast('ูุง ูููู ุญุฐู ุงููุฆุฉุ ูุฑุชุจุทุฉ ุจููุชุฌุงุช.', 'error'); return; }
        showConfirmModal('ูู ุชุฑูุฏ ุญุฐู ูุฐู ุงููุฆุฉุ', () => deleteCategory(id));
    }
    function deleteCategory(id) {
        state.categories = state.categories.filter(c => c.id !== id);
        saveState(); renderCategoriesTable(); showToast('ุชู ุญุฐู ุงููุฆุฉ.');
    }

    // --- Product Management ---
    if(document.getElementById('addProductBtn')) {
        document.getElementById('addProductBtn').addEventListener('click', () => {
            const categoryOptions = state.categories.map(c => ({ value: c.id, text: c.name }));
            const unitOptions = productUnits.map(u => ({ value: u.key, text: u.name }));
            if (categoryOptions.length === 0) { showToast('ูุฌุจ ุฅุถุงูุฉ ูุฆุฉ ููุชุฌุงุช ุฃููุงู.', 'error'); showPage('categories'); return; }
            const fields = [
                { id: 'productName', name: 'name', label: 'ุงุณู ุงูููุชุฌ:', type: 'text', required: true },
                { id: 'productCategoryId', name: 'categoryId', label: 'ุงููุฆุฉ:', type: 'select', options: [{value:'', text:'ุงุฎุชุฑ ูุฆุฉ'}, ...categoryOptions], required: true },
                { id: 'productUnit', name: 'unit', label: 'ูุญุฏุฉ ุงูููุงุณ:', type: 'select', options: unitOptions, required: true },
                { id: 'productSalePrice', name: 'price', label: `ุณุนุฑ ุงูุจูุน (${state.currency.symbol}):`, type: 'number', step: '0.01', min: 0, required: true },
                { id: 'productCostPrice', name: 'costPrice', label: `ุชูููุฉ ุงูุดุฑุงุก (${state.currency.symbol}):`, type: 'number', step: '0.01', min: 0 },
                { id: 'productQuantity', name: 'quantity', label: 'ุงููููุฉ ุงูุฃูููุฉ:', type: 'number', min: 0, required: true },
                { id: 'productReorderLimit', name: 'reorderLimit', label: 'ุญุฏ ุฅุนุงุฏุฉ ุงูุทูุจ:', type: 'number', min: 0, placeholder: '10' },
                { id: 'productBarcode', name: 'barcode', label: 'ุงูุจุงุฑููุฏ (ุงุฎุชูุงุฑู):', type: 'text' },
                { id: 'productDescription', name: 'description', label: 'ูุตู ุงูููุชุฌ:', type: 'textarea' },
            ];
            buildForm(fields, { costPrice: 0, reorderLimit: 10, unit: 'unit' }, handleSaveProduct, 'ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ');
        });
    }
    function handleSaveProduct(productData) {
        productData.price = parseFloat(productData.price);
        productData.costPrice = parseFloat(productData.costPrice || 0);
        productData.quantity = parseInt(productData.quantity, 10);
        productData.reorderLimit = parseInt(productData.reorderLimit || 10, 10);
        if (productData.id) {
            const index = state.products.findIndex(p => p.id === productData.id);
            if (index !== -1) state.products[index] = { ...state.products[index], ...productData };
        } else { state.products.push({ id: generateId(), ...productData }); }
        saveState(); renderProductsTable(); renderInventoryTable(); renderDashboard(); showToast(`ุชู ${productData.id ? 'ุชุญุฏูุซ' : 'ุญูุธ'} ุงูููุชุฌ!`);
    }
    function renderProductsTable() {
        const productsTableBody = document.querySelector('#productsTable tbody');
        if (!productsTableBody) return;
        productsTableBody.innerHTML = '';
        if (state.products.length === 0) { productsTableBody.innerHTML = '<tr><td colspan="9" style="text-align:center;">ูุง ุชูุฌุฏ ููุชุฌุงุช.</td></tr>'; return; }
        state.products.forEach((product, index) => {
            const category = state.categories.find(c => c.id === product.categoryId);
            const row = productsTableBody.insertRow();
            row.innerHTML = `<td>${index + 1}</td>
                <td>${product.name} ${product.barcode ? `<br><small style="color:gray;">(${product.barcode})</small>` : ''}</td>
                <td>${category ? category.name : 'ุบูุฑ ูุญุฏุฏ'}</td><td>${formatCurrency(product.price)}</td>
                <td>${formatCurrency(product.costPrice)}</td><td>${product.quantity}</td>
                <td>${getUnitName(product.unit)}</td>
                <td>${product.reorderLimit || 10}</td>
                <td class="action-buttons">
                    <button class="small" onclick="editProduct('${product.id}')"><span class="icon">โ๏ธ</span> ุชุนุฏูู</button>
                    <button class="small danger" onclick="confirmDeleteProduct('${product.id}')"><span class="icon">๐๏ธ</span> ุญุฐู</button>
                </td>`;
        });
    }
    function editProduct(id) {
        const product = state.products.find(p => p.id === id);
        if (product) {
            const categoryOptions = state.categories.map(c => ({ value: c.id, text: c.name }));
            const unitOptions = productUnits.map(u => ({ value: u.key, text: u.name }));
            const fields = [
                { id: 'productName', name: 'name', label: 'ุงุณู ุงูููุชุฌ:', type: 'text', required: true },
                { id: 'productCategoryId', name: 'categoryId', label: 'ุงููุฆุฉ:', type: 'select', options: [{value:'', text:'ุงุฎุชุฑ ูุฆุฉ'}, ...categoryOptions], required: true },
                { id: 'productUnit', name: 'unit', label: 'ูุญุฏุฉ ุงูููุงุณ:', type: 'select', options: unitOptions, required: true },
                { id: 'productSalePrice', name: 'price', label: `ุณุนุฑ ุงูุจูุน (${state.currency.symbol}):`, type: 'number', step: '0.01', min: 0, required: true },
                { id: 'productCostPrice', name: 'costPrice', label: `ุชูููุฉ ุงูุดุฑุงุก (${state.currency.symbol}):`, type: 'number', step: '0.01', min: 0 },
                { id: 'productQuantity', name: 'quantity', label: 'ุงููููุฉ:', type: 'number', min: 0, required: true },
                { id: 'productReorderLimit', name: 'reorderLimit', label: 'ุญุฏ ุฅุนุงุฏุฉ ุงูุทูุจ:', type: 'number', min: 0 },
                { id: 'productBarcode', name: 'barcode', label: 'ุงูุจุงุฑููุฏ (ุงุฎุชูุงุฑู):', type: 'text' },
                { id: 'productDescription', name: 'description', label: 'ูุตู ุงูููุชุฌ:', type: 'textarea' },
            ];
            buildForm(fields, product, handleSaveProduct, 'ุชุนุฏูู ุงูููุชุฌ');
        }
    }
    function confirmDeleteProduct(id) {
        showConfirmModal('ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงูููุชุฌุ ุณูุชู ุญุฐูู ูู ุงููุธุงู ุจุดูู ููุงุฆู.', () => deleteProduct(id));
    }
    function deleteProduct(id) {
        state.products = state.products.filter(p => p.id !== id);
        saveState(); renderProductsTable(); renderInventoryTable(); renderDashboard(); showToast('ุชู ุญุฐู ุงูููุชุฌ.');
    }

    // --- Inventory Management ---
    function renderInventoryTable() {
        const inventoryTableBody = document.querySelector('#inventoryTable tbody');
        if (!inventoryTableBody) return;
        inventoryTableBody.innerHTML = '';
        if (state.products.length === 0) { inventoryTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">ูุง ุชูุฌุฏ ููุชุฌุงุช.</td></tr>'; return; }
        const sortedProducts = [...state.products].sort((a,b) => a.name.localeCompare(b.name));
        sortedProducts.forEach((product, index) => {
            const row = inventoryTableBody.insertRow();
            let statusClass = 'badge-success'; let statusText = 'ูุชููุฑ';
            if (product.quantity <= 0) { statusClass = 'badge-danger'; statusText = 'ููุฐ ุงููุฎุฒูู'; }
            else if (product.quantity <= (product.reorderLimit || 0)) { statusClass = 'badge-warning'; statusText = 'ููุฎูุถ'; }
            const inventoryValue = (product.costPrice || 0) * product.quantity;
            row.innerHTML = `<td>${index + 1}</td><td>${product.name}</td><td>${product.quantity}</td>
                <td>${getUnitName(product.unit)}</td>
                <td>${product.reorderLimit || 10}</td><td><span class="badge ${statusClass}">${statusText}</span></td>
                <td>${formatCurrency(inventoryValue)}</td>`;
        });
    }

    // --- Customer Management ---
    if(document.getElementById('addCustomerBtn')) {
        document.getElementById('addCustomerBtn').addEventListener('click', () => {
            buildForm([
                { id: 'customerName', name: 'name', label: 'ุงุณู ุงูุนููู:', type: 'text', required: true },
                { id: 'customerPhone', name: 'phone', label: 'ุงููุงุชู:', type: 'tel' },
                { id: 'customerEmail', name: 'email', label: 'ุงูุจุฑูุฏ:', type: 'email' },
                { id: 'customerAddress', name: 'address', label: 'ุงูุนููุงู:', type: 'textarea' },
            ], {}, handleSaveCustomer, 'ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ');
        });
    }
    function handleSaveCustomer(customerData) {
        if (customerData.id) {
            const index = state.customers.findIndex(c => c.id === customerData.id);
            if (index !== -1) state.customers[index] = { ...state.customers[index], ...customerData };
        } else { state.customers.push({ id: generateId(), ...customerData, totalSpent: 0, lastPurchaseDate: null, debt: 0, debtHistory: [] }); }
        saveState(); renderCustomersTable(); renderDashboard(); showToast(`ุชู ${customerData.id ? 'ุชุญุฏูุซ' : 'ุญูุธ'} ุงูุนููู!`);
    }
    function renderCustomersTable() {
        const customersTableBody = document.querySelector('#customersTable tbody');
        if (!customersTableBody) return;
        customersTableBody.innerHTML = '';
        const posCustomerSelect = document.getElementById('posCustomerSelect');
        if(posCustomerSelect) posCustomerSelect.innerHTML = '<option value="">-- ุนููู ุนุงู --</option>';
        if (state.customers.length === 0) { customersTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">ูุง ููุฌุฏ ุนููุงุก.</td></tr>'; return; }
        state.customers.forEach((customer, index) => {
            const row = customersTableBody.insertRow();
            const customerSales = state.sales.filter(s => s.customerId === customer.id);
            const totalSpent = customerSales.reduce((sum, sale) => sum + sale.totalAmount, 0);
            const lastSale = customerSales.sort((a,b) => new Date(b.date) - new Date(a.date))[0];
            row.innerHTML = `<td>${index + 1}</td><td>${customer.name}</td><td>${customer.phone || '-'}</td>
                <td>${customer.email || '-'}</td><td>${formatCurrency(totalSpent)}</td>
                <td class="${(customer.debt || 0) > 0 ? 'text-danger' : ''}">${formatCurrency(customer.debt || 0)}</td>
                <td>${lastSale ? formatDate(lastSale.date) : '-'}</td>
                <td class="action-buttons">
                    <button class="small" onclick="editCustomer('${customer.id}')"><span class="icon">โ๏ธ</span> ุชุนุฏูู</button>
                    ${(customer.debt || 0) > 0 ? `<button class="small success" onclick="openDebtPaymentModal('${customer.id}')"><span class="icon">๐ฐ</span> ุณุฏุงุฏ</button>` : ''}
                    <button class="small danger" onclick="confirmDeleteCustomer('${customer.id}')"><span class="icon">๐๏ธ</span> ุญุฐู</button>
                </td>`;
            if(posCustomerSelect) {
                const option = document.createElement('option');
                option.value = customer.id; option.textContent = customer.name;
                posCustomerSelect.appendChild(option);
            }
        });
    }
    function editCustomer(id) {
        const customer = state.customers.find(c => c.id === id);
        if (customer) buildForm([
            { id: 'customerName', name: 'name', label: 'ุงุณู ุงูุนููู:', type: 'text', required: true },
            { id: 'customerPhone', name: 'phone', label: 'ุงููุงุชู:', type: 'tel' },
            { id: 'customerEmail', name: 'email', label: 'ุงูุจุฑูุฏ:', type: 'email' },
            { id: 'customerAddress', name: 'address', label: 'ุงูุนููุงู:', type: 'textarea' },
        ], customer, handleSaveCustomer, 'ุชุนุฏูู ุงูุนููู');
    }
    function confirmDeleteCustomer(id) {
        const customer = state.customers.find(c => c.id === id);
        if (customer && (customer.debt || 0) > 0) {
            showToast('ูุง ูููู ุญุฐู ุงูุนูููุ ูุฏูู ุฏูู ูุณุชุญู.', 'error');
            return;
        }
        if (state.sales.some(s => s.customerId === id)) {
            showConfirmModal('ูุฐุง ุงูุนููู ูุฏูู ูุจูุนุงุช ูุณุฌูุฉ. ุญุฐูู ุณูุฌุนู ูุฐู ุงููุจูุนุงุช ุชุงุจุนุฉ ูู "ุนููู ุนุงู". ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ', () => deleteCustomer(id), 'ุชุญุฐูุฑ');
        } else { showConfirmModal('ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงูุนูููุ', () => deleteCustomer(id)); }
    }
    function deleteCustomer(id) {
        state.customers = state.customers.filter(c => c.id !== id);
        state.sales.forEach(sale => { if (sale.customerId === id) sale.customerId = null; });
        saveState(); renderCustomersTable(); renderDashboard(); renderSalesReport(); showToast('ุชู ุญุฐู ุงูุนููู.');
    }

    // --- Customer Debts Page ---
    function renderCustomerDebtsPage() {
        const debtsTableBody = document.querySelector('#customerDebtsTable tbody');
        if(!debtsTableBody) return;
        debtsTableBody.innerHTML = '';
        const indebtedCustomers = state.customers.filter(c => (c.debt || 0) > 0);
        if (indebtedCustomers.length === 0) {
            debtsTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ูุง ุชูุฌุฏ ุฏููู ูุณุชุญูุฉ ุนูู ุงูุนููุงุก ุญุงููุงู.</td></tr>';
            return;
        }
        indebtedCustomers.forEach(customer => {
            const lastDebtUpdate = customer.debtHistory && customer.debtHistory.length > 0 ?
                                   [...customer.debtHistory].pop().date :
                                   (customer.lastPurchaseDate || null);
            const row = debtsTableBody.insertRow();
            row.innerHTML = `<td>${customer.name}</td>
                             <td class="text-danger">${formatCurrency(customer.debt)}</td>
                             <td>${lastDebtUpdate ? formatDate(lastDebtUpdate) : '-'}</td>
                             <td class="action-buttons">
                                 <button class="small success" onclick="openDebtPaymentModal('${customer.id}')"><span class="icon">๐ฐ</span> ุชุณุฌูู ุฏูุนุฉ</button>
                             </td>`;
        });
    }

    function openDebtPaymentModal(customerId) {
        const customer = state.customers.find(c => c.id === customerId);
        if (!customer || !debtPaymentModalElement) return;

        debtPaymentModalElement.dataset.customerId = customerId;
        document.getElementById('debtPaymentCustomerName').textContent = customer.name;
        document.getElementById('debtPaymentCurrentDebt').textContent = formatCurrency(customer.debt);
        const amountInput = document.getElementById('debtPaymentAmount');
        amountInput.value = customer.debt;
        amountInput.max = customer.debt;
        document.getElementById('debtPaymentDate').value = formatDateForInput(new Date());

        openModal(debtPaymentModalElement);
    }
    
    document.getElementById('debtPaymentForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const customerId = debtPaymentModalElement.dataset.customerId;
        const customer = state.customers.find(c => c.id === customerId);
        if(!customer) return;

        const formData = new FormData(e.target);
        const paymentAmount = parseFloat(formData.get('amount'));
        const paymentDate = new Date(formData.get('date'));

        if(isNaN(paymentAmount) || paymentAmount <= 0) {
            showToast('ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุจูุบ ุตุญูุญ.', 'error');
            return;
        }
        if(paymentAmount > customer.debt) {
            showToast('ูุจูุบ ุงูุฏูุนุฉ ุฃูุจุฑ ูู ุงูุฏูู ุงููุณุชุญู.', 'error');
            return;
        }

        customer.debt -= paymentAmount;
        if (!customer.debtHistory) customer.debtHistory = [];
        customer.debtHistory.push({
            type: 'payment',
            amount: paymentAmount,
            date: paymentDate,
            newBalance: customer.debt
        });

        saveState();
        showToast('ุชู ุชุณุฌูู ุงูุฏูุนุฉ ุจูุฌุงุญ!', 'success');
        closeModal(debtPaymentModalElement);
        renderCustomerDebtsPage();
        renderCustomersTable();
        renderDashboard();
    });

    // --- POS (Point of Sale) ---
    const posProductSearchInput = document.getElementById('posProductSearch');
    const posProductSearchResultsDiv = document.getElementById('posProductSearchResults');
    const posCartTableBody = document.querySelector('#posCartTable tbody');
    const posSubtotalAmountSpan = document.getElementById('posSubtotalAmount');
    const posTaxAmountSpan = document.getElementById('posTaxAmount');
    const posTotalAmountSpan = document.getElementById('posTotalAmount');
    const completeSaleBtn = document.getElementById('completeSaleBtn');
    const clearCartBtn = document.getElementById('clearCartBtn');
    const posPaymentMethodSelect = document.getElementById('posPaymentMethod');

    function renderPosPage() {
        if (posProductSearchInput) posProductSearchInput.value = '';
        if (posProductSearchResultsDiv) posProductSearchResultsDiv.innerHTML = '';
        renderPosCart();
        const posCustomerSelect = document.getElementById('posCustomerSelect');
        if (posCustomerSelect) {
            const currentVal = posCustomerSelect.value;
            posCustomerSelect.innerHTML = '<option value="">-- ุนููู ุนุงู --</option>';
            state.customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id; option.textContent = customer.name;
                posCustomerSelect.appendChild(option);
            });
            posCustomerSelect.value = currentVal;
        }
        const taxRateDisplay = document.getElementById('posTaxRateDisplay');
        if (taxRateDisplay) taxRateDisplay.textContent = (state.taxRate * 100).toFixed(0);
    }
    if(posProductSearchInput) {
        posProductSearchInput.addEventListener('input', () => {
            const searchTerm = posProductSearchInput.value.toLowerCase().trim();
            if(posProductSearchResultsDiv) posProductSearchResultsDiv.innerHTML = '';
            if (!searchTerm) return;
            const matchedProducts = state.products.filter(p =>
                (p.name.toLowerCase().includes(searchTerm) || (p.barcode && p.barcode.includes(searchTerm)) || p.id.includes(searchTerm)) && p.quantity > 0
            );
            if (matchedProducts.length > 0) {
                const ul = document.createElement('ul');
                matchedProducts.slice(0, 10).forEach(product => {
                    const li = document.createElement('li');
                    li.innerHTML = `<div>${product.name}</div><div class="stock">ุงููุชููุฑ: ${product.quantity} ${getUnitName(product.unit)}, ุงูุณุนุฑ: ${formatCurrency(product.price)}</div>`;
                    li.onclick = () => addProductToCart(product.id);
                    ul.appendChild(li);
                });
                if(posProductSearchResultsDiv) posProductSearchResultsDiv.appendChild(ul);
            } else {
                if(posProductSearchResultsDiv) posProductSearchResultsDiv.innerHTML = '<li style="padding:10px;text-align:center;cursor:default;">ูุง ุชูุฌุฏ ููุชุฌุงุช ูุทุงุจูุฉ.</li>';
            }
        });
    }
    function addProductToCart(productId) {
        const product = state.products.find(p => p.id === productId);
        if (!product || product.quantity <= 0) { showToast('ุงูููุชุฌ ุบูุฑ ูุชููุฑ.', 'error'); return; }
        const existingCartItem = state.currentCart.find(item => item.id === productId);
        if (existingCartItem) {
            if (existingCartItem.quantityInCart < product.quantity) existingCartItem.quantityInCart++;
            else { showToast('ูุง ูููู ุฅุถุงูุฉ ูููุฉ ุฃูุจุฑ ูู ุงููุชููุฑ.', 'error'); return; }
        } else { state.currentCart.push({ ...structuredClone(product), quantityInCart: 1 }); }
        if (posProductSearchInput) { posProductSearchInput.value = ''; posProductSearchInput.focus(); }
        if (posProductSearchResultsDiv) posProductSearchResultsDiv.innerHTML = '';
        renderPosCart();
    }
    function updateCartItemQuantity(productId, change) {
        const cartItemIndex = state.currentCart.findIndex(item => item.id === productId);
        if (cartItemIndex === -1) return;
        const cartItem = state.currentCart[cartItemIndex];
        const originalProduct = state.products.find(p => p.id === productId);
        if (!originalProduct) return;
        const newQuantity = cartItem.quantityInCart + change;
        if (newQuantity <= 0) state.currentCart.splice(cartItemIndex, 1);
        else if (newQuantity > originalProduct.quantity) {
            showToast('ุงููููุฉ ุงููุทููุจุฉ ุชุชุฌุงูุฒ ุงููุฎุฒูู.', 'error'); cartItem.quantityInCart = originalProduct.quantity;
        } else cartItem.quantityInCart = newQuantity;
        renderPosCart();
    }
    function removeProductFromCart(productId) {
        state.currentCart = state.currentCart.filter(item => item.id !== productId);
        renderPosCart();
    }
    function renderPosCart() {
        if (!posCartTableBody) return;
        posCartTableBody.innerHTML = ''; let subtotal = 0;
        if (state.currentCart.length === 0) {
            posCartTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ุงูุณูุฉ ูุงุฑุบุฉ.</td></tr>';
            completeSaleBtn.disabled = true;
        } else {
            completeSaleBtn.disabled = false;
            state.currentCart.forEach(item => {
                const itemTotal = item.price * item.quantityInCart; subtotal += itemTotal;
                const row = posCartTableBody.insertRow();
                row.innerHTML = `<td>${item.name}</td>
                    <td>
                        <button class="small" onclick="updateCartItemQuantity('${item.id}', -1)">-</button>
                        <span style="margin: 0 5px; display: inline-block; min-width: 20px; text-align: center;">${item.quantityInCart} ${getUnitName(item.unit)}</span>
                        <button class="small" onclick="updateCartItemQuantity('${item.id}', 1)">+</button>
                    </td>
                    <td>${formatCurrency(item.price)}</td><td>${formatCurrency(itemTotal)}</td>
                    <td><button class="small danger" onclick="removeProductFromCart('${item.id}')"><span class="icon">๐๏ธ</span></button></td>`;
            });
        }
        const taxAmount = subtotal * state.taxRate; const totalAmount = subtotal + taxAmount;
        if (posSubtotalAmountSpan) posSubtotalAmountSpan.textContent = formatCurrency(subtotal);
        if (posTaxAmountSpan) posTaxAmountSpan.textContent = formatCurrency(taxAmount);
        if (posTotalAmountSpan) posTotalAmountSpan.textContent = formatCurrency(totalAmount);
    }
    if(clearCartBtn) {
        clearCartBtn.addEventListener('click', () => {
            if (state.currentCart.length > 0) showConfirmModal('ูู ุฃูุช ูุชุฃูุฏ ูู ุฑุบุจุชู ูู ุฅูุฑุงุบ ุงูุณูุฉุ', () => {
                state.currentCart = []; renderPosCart(); showToast('ุชู ุฅูุฑุงุบ ุงูุณูุฉ.');
            });
        });
    }
    if(completeSaleBtn) {
        completeSaleBtn.addEventListener('click', () => {
            if (state.currentCart.length === 0) { showToast('ุงูุณูุฉ ูุงุฑุบุฉ. ูุง ูููู ุฅุชูุงู ุงูุจูุน.', 'error'); return; }
            
            const selectedCustomerId = document.getElementById('posCustomerSelect')?.value;
            const paymentMethod = posPaymentMethodSelect ? posPaymentMethodSelect.value : 'cash';

            if (paymentMethod === 'debt' && !selectedCustomerId) {
                showToast('ูุฌุจ ุงุฎุชูุงุฑ ุนููู ูุชุณุฌูู ุนูููุฉ ุจูุน ุขุฌูุฉ.', 'error');
                return;
            }

            const saleId = 'INV-' + generateId().substring(0,6).toUpperCase();
            const saleDate = new Date(); let saleSubtotal = 0;
            
            const saleItems = state.currentCart.map(item => {
                saleSubtotal += item.price * item.quantityInCart;
                const productInDb = state.products.find(p => p.id === item.id);
                if (productInDb) productInDb.quantity -= item.quantityInCart;
                return { productId: item.id, name: item.name, quantity: item.quantityInCart, unit: item.unit, price: item.price, subtotal: item.price * item.quantityInCart };
            });

            const taxAmount = saleSubtotal * state.taxRate; const totalAmount = saleSubtotal + taxAmount;
            
            const newSale = {
                id: saleId, date: saleDate, customerId: selectedCustomerId || null, items: saleItems,
                subtotalAmount: saleSubtotal, taxAmount: taxAmount, totalAmount: totalAmount, paymentMethod: paymentMethod,
                currencyCode: state.currency.code, currencySymbol: state.currency.symbol
            };
            state.sales.push(newSale);

            if (selectedCustomerId) {
                const customer = state.customers.find(c => c.id === selectedCustomerId);
                if (customer) {
                    customer.lastPurchaseDate = saleDate;
                    if (paymentMethod === 'debt') {
                        customer.debt = (customer.debt || 0) + totalAmount;
                        if (!customer.debtHistory) customer.debtHistory = [];
                        customer.debtHistory.push({
                            type: 'invoice',
                            amount: totalAmount,
                            date: saleDate,
                            invoiceId: saleId,
                            newBalance: customer.debt
                        });
                    }
                }
            }

            saveState();
            document.getElementById('confirmSaleId').textContent = newSale.id;
            document.getElementById('confirmSaleTotal').textContent = formatCurrency(newSale.totalAmount);
            if (saleConfirmationModalElement) saleConfirmationModalElement.dataset.currentSaleId = newSale.id;
            
            // Setup confirmation modal actions
            const printInvoiceBtn = document.getElementById('printInvoiceBtn');
            const emailInvoiceBtn = document.getElementById('emailInvoiceBtn');
            const emailInvoiceInputGroup = document.getElementById('emailInvoiceInputGroup');
            const customerEmailForInvoiceInput = document.getElementById('customerEmailForInvoice');
            const sendEmailConfirmBtn = document.getElementById('sendEmailConfirmBtn');
            
            if(printInvoiceBtn) printInvoiceBtn.onclick = () => handlePrintInvoice(newSale.id);
            
            if(emailInvoiceBtn && emailInvoiceInputGroup && customerEmailForInvoiceInput) {
                emailInvoiceBtn.onclick = () => {
                    emailInvoiceInputGroup.style.display = 'block';
                    const customer = newSale.customerId ? state.customers.find(c => c.id === newSale.customerId) : null;
                    customerEmailForInvoiceInput.value = (customer && customer.email) ? customer.email : '';
                };
            }
            if(sendEmailConfirmBtn && customerEmailForInvoiceInput) {
                sendEmailConfirmBtn.onclick = () => {
                    const emailAddress = customerEmailForInvoiceInput.value.trim();
                    if (emailAddress && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailAddress)) handleEmailInvoice(newSale.id, emailAddress);
                    else showToast('ุจุฑูุฏ ุฅููุชุฑููู ุบูุฑ ุตุญูุญ.', 'error');
                };
            }
            
            openModal(saleConfirmationModalElement);
            state.currentCart = []; 
            renderPosPage(); // Reset POS page
            renderInventoryTable(); 
            renderDashboard(); 
            renderSalesReport();
            if (selectedCustomerId) {
                renderCustomersTable();
                renderCustomerDebtsPage();
            }
        });
    }

    // --- Sales & Reports ---
    const salesReportTableBody = document.querySelector('#salesReportTable tbody');
    const generateReportBtn = document.getElementById('generateReportBtn');
    const clearReportFilterBtn = document.getElementById('clearReportFilterBtn');
    const reportStartDateInput = document.getElementById('reportStartDate');
    const reportEndDateInput = document.getElementById('reportEndDate');

    function getPaymentMethodText(methodKey) {
        const methods = { cash: "ููุฏุงู", card: "ุจุทุงูุฉ", online: "ุฅููุชุฑููู", other: "ุฃุฎุฑู", debt: "ุขุฌู/ุฏูู" };
        return methods[methodKey] || methodKey;
    }
    function renderSalesReport() {
        if (!salesReportTableBody) return;
        salesReportTableBody.innerHTML = ''; let filteredSales = [...state.sales];
        const startDate = reportStartDateInput?.value ? new Date(reportStartDateInput.value) : null;
        const endDate = reportEndDateInput?.value ? new Date(reportEndDateInput.value) : null;
        if (startDate) { startDate.setHours(0,0,0,0); filteredSales = filteredSales.filter(sale => new Date(sale.date) >= startDate); }
        if (endDate) { endDate.setHours(23,59,59,999); filteredSales = filteredSales.filter(sale => new Date(sale.date) <= endDate); }
        filteredSales.sort((a,b) => new Date(b.date) - new Date(a.date));
        if (filteredSales.length === 0) { salesReportTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">ูุง ุชูุฌุฏ ูุจูุนุงุช ุชุทุงุจู ุงูููุชุฑ.</td></tr>`; return; }
        filteredSales.forEach(sale => {
            const customer = sale.customerId ? state.customers.find(c => c.id === sale.customerId) : null;
            const row = salesReportTableBody.insertRow();
            const sym = sale.currencySymbol || state.currency.symbol;
            row.innerHTML = `<td>${sale.id}</td><td>${formatDate(sale.date)}</td>
                <td>${customer ? customer.name : 'ุนููู ุนุงู'}</td><td>${sale.items.length}</td>
                <td>${getPaymentMethodText(sale.paymentMethod || 'cash')}</td>
                <td>${parseFloat(sale.totalAmount).toFixed(2)} ${sym}</td>
                <td><button class="small primary" onclick="viewSaleDetails('${sale.id}')"><span class="icon">๐๏ธ</span> ุนุฑุถ</button></td>`;
        });
    }
    if(generateReportBtn) generateReportBtn.addEventListener('click', renderSalesReport);
    if(clearReportFilterBtn) {
        clearReportFilterBtn.addEventListener('click', () => {
            if(reportStartDateInput) reportStartDateInput.value = '';
            if(reportEndDateInput) reportEndDateInput.value = '';
            renderSalesReport();
        });
    }
    function viewSaleDetails(saleId) {
        const sale = state.sales.find(s => s.id === saleId);
        if (!sale || !saleDetailsModalElement) return;
        saleDetailsModalElement.dataset.currentSaleIdForActions = saleId;
        const sym = sale.currencySymbol || state.currency.symbol;
        document.getElementById('detailsSaleId').textContent = sale.id;
        document.getElementById('detailsSaleDate').textContent = formatDate(sale.date);
        const customer = sale.customerId ? state.customers.find(c => c.id === sale.customerId) : null;
        document.getElementById('detailsSaleCustomer').textContent = customer ? customer.name : 'ุนููู ุนุงู';
        document.getElementById('detailsSalePaymentMethod').textContent = getPaymentMethodText(sale.paymentMethod || 'cash');
        document.getElementById('detailsSaleSubtotal').textContent = `${parseFloat(sale.subtotalAmount).toFixed(2)} ${sym}`;
        document.getElementById('detailsSaleTax').textContent = `${parseFloat(sale.taxAmount).toFixed(2)} ${sym}`;
        document.getElementById('detailsSaleTotal').textContent = `${parseFloat(sale.totalAmount).toFixed(2)} ${sym}`;
        const itemsTableBody = saleDetailsModalElement.querySelector('#detailsSaleItemsTable tbody');
        if(itemsTableBody) {
            itemsTableBody.innerHTML = '';
            sale.items.forEach(item => {
                const row = itemsTableBody.insertRow();
                row.innerHTML = `<td>${item.name}</td><td>${item.quantity} ${getUnitName(item.unit || 'unit')}</td>
                    <td>${parseFloat(item.price).toFixed(2)} ${sym}</td>
                    <td>${parseFloat(item.subtotal).toFixed(2)} ${sym}</td>`;
            });
        }
        openModal(saleDetailsModalElement);
    }

    // --- Invoice & Quote Printing/Emailing ---
    function generateInvoiceHTML(sale, type = 'invoice') {
        const customer = sale.customerId ? state.customers.find(c => c.id === sale.customerId) : null;
        let itemsHtml = ''; const sym = sale.currencySymbol || state.currency.symbol;
        const headerTitle = type === 'invoice' ? 'ูุงุชูุฑุฉ ูุจูุนุงุช' : 'ุนุฑุถ ุณุนุฑ / ูุงุชูุฑุฉ ุฃูููุฉ';
        const idLabel = type === 'invoice' ? 'ุฑูู ุงููุงุชูุฑุฉ' : 'ุฑูู ุงูุนุฑุถ';
        sale.items.forEach(item => {
            itemsHtml += `<tr><td>${item.name}</td><td>${item.quantity} ${getUnitName(item.unit || 'unit')}</td>
                <td>${parseFloat(item.price || item.costPrice).toFixed(2)} ${sym}</td>
                <td>${parseFloat(item.subtotal).toFixed(2)} ${sym}</td></tr>`;
        });
        const { name: storeName, address, phone, email, logoUrl } = state.storeDetails;
        let summaryHtml = `<p><strong>ุงูุฅุฌูุงูู ุงููุฑุนู:</strong> ${parseFloat(sale.subtotalAmount).toFixed(2)} ${sym}</p>
                           <p><strong>ุงูุถุฑูุจุฉ (${(state.taxRate * 100).toFixed(0)}%):</strong> ${parseFloat(sale.taxAmount).toFixed(2)} ${sym}</p>
                           <p><strong>ุงูุฅุฌูุงูู ุงูููู:</strong> ${parseFloat(sale.totalAmount).toFixed(2)} ${sym}</p>`;
        
        return `
            ${logoUrl ? `<div style="text-align:center;margin-bottom:10px;"><img src="${logoUrl}" alt="ุดุนุงุฑ" style="max-height:80px;max-width:200px;"></div>` : ''}
            <div class="invoice-header" style="text-align:center;margin-bottom:20px;">
                <h2>${storeName || 'ุงููุญู ุงูุชุฌุงุฑู'}</h2><p>${address || ''}</p><p>${phone ? `ุงููุงุชู: ${phone}`:''} ${email ? `| ุงูุจุฑูุฏ: ${email}` : ''}</p><hr><h3>${headerTitle}</h3>
            </div>
            <div style="margin-bottom:15px;">
                <p><strong>${idLabel}:</strong> ${sale.id}</p><p><strong>ุงูุชุงุฑูุฎ:</strong> ${formatDate(sale.date)}</p>
                <p><strong>ุงูุนููู:</strong> ${customer ? customer.name : 'ุนููู ุนุงู'}</p>
                ${customer && customer.phone ? `<p><strong>ูุงุชู ุงูุนููู:</strong> ${customer.phone}</p>` : ''}
                ${type === 'invoice' ? `<p><strong>ุทุฑููุฉ ุงูุฏูุน:</strong> ${getPaymentMethodText(sale.paymentMethod || 'cash')}</p>`: ''}
            </div>
            <table><thead><tr><th>ุงูููุชุฌ</th><th>ุงููููุฉ</th><th>ุงูุณุนุฑ</th><th>ุงูุฅุฌูุงูู</th></tr></thead><tbody>${itemsHtml}</tbody></table>
            <div class="invoice-summary" style="margin-top:20px;text-align:left;padding-right:10px;">${summaryHtml}</div>
            <div style="text-align:center;margin-top:30px;font-size:0.9em;"><p>${sale.notes || 'ุดูุฑุงู ูุชุนุงูููู ูุนูุง!'}</p>${storeName ? `<p>${storeName}</p>`:''}</div>`;
    }
    function handlePrintInvoice(saleId) {
        const sale = state.sales.find(s => s.id === saleId);
        if (!sale) { showToast('ุงููุงุชูุฑุฉ ุบูุฑ ููุฌูุฏุฉ.', 'error'); return; }
        const invoiceHtmlContent = generateInvoiceHTML(sale, 'invoice');
        const invoiceToPrintDiv = document.getElementById('invoiceToPrint');
        if(invoiceToPrintDiv) {
            invoiceToPrintDiv.innerHTML = invoiceHtmlContent;
            window.print();
        }
    }
    function handleEmailInvoice(saleId, customerEmail) {
        const sale = state.sales.find(s => s.id === saleId);
        if (!sale) { showToast('ุงููุงุชูุฑุฉ ุบูุฑ ููุฌูุฏุฉ.', 'error'); return; }
        const { name: storeName } = state.storeDetails; const sym = sale.currencySymbol || state.currency.symbol;
        const subject = `ูุงุชูุฑุฉ ูู ${storeName} - ุฑูู: ${sale.id}`;
        let emailBody = `ูุฑุญุจุงูุ\n\nุดูุฑุงู ูุชุนุงูููู ูุน ${storeName}.\nุชูุงุตูู ูุงุชูุฑุชูู ุฑูู ${sale.id} ุจุชุงุฑูุฎ ${formatDate(sale.date)}:\n`;
        emailBody += `ุทุฑููุฉ ุงูุฏูุน: ${getPaymentMethodText(sale.paymentMethod || 'cash')}\n\n`;
        sale.items.forEach(item => {
            emailBody += `- ${item.name} (ุงููููุฉ: ${item.quantity} ${getUnitName(item.unit || 'unit')}, ุงูุณุนุฑ: ${parseFloat(item.price).toFixed(2)} ${sym}) - ุงูุฅุฌูุงูู: ${parseFloat(item.subtotal).toFixed(2)} ${sym}\n`;
        });
        emailBody += `\nุงูุฅุฌูุงูู ุงููุฑุนู: ${parseFloat(sale.subtotalAmount).toFixed(2)} ${sym}\n`;
        emailBody += `ุงูุถุฑูุจุฉ (${(state.taxRate * 100).toFixed(0)}%): ${parseFloat(sale.taxAmount).toFixed(2)} ${sym}\n`;
        emailBody += `ุงูุฅุฌูุงูู ุงูููู: ${parseFloat(sale.totalAmount).toFixed(2)} ${sym}\n\nูุน ุชุญูุงุช ูุฑูู ${storeName}.\n\nููุงุญุธุฉ: ูุฐู ุฑุณุงูุฉ ุขููุฉ.`;
        const mailtoLink = `mailto:${customerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
        const newWindow = window.open(mailtoLink, '_blank');
        if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') showToast('ุชุนุฐุฑ ูุชุญ ุจุฑูุงูุฌ ุงูุจุฑูุฏ. ูุฏ ุชุญุชุงุฌ ููุณูุงุญ ุจุงูููุงูุฐ ุงูููุจุซูุฉ.', 'error', 5000);
        else showToast('ูุฑุฌู ุฅููุงู ุงูุฅุฑุณุงู ูู ุจุฑูุงูุฌ ุงูุจุฑูุฏ.', 'success');
        if(document.getElementById('emailInvoiceInputGroup')) document.getElementById('emailInvoiceInputGroup').style.display = 'none';
        if(document.getElementById('customerEmailForInvoice')) document.getElementById('customerEmailForInvoice').value = '';
        if(saleConfirmationModalElement) closeModal(saleConfirmationModalElement);
    }

    // --- Dashboard ---
    function renderDashboard() {
        document.getElementById('total-products-stat').textContent = state.products.length;
        document.getElementById('total-customers-stat').textContent = state.customers.length;
        document.getElementById('total-suppliers-stat').textContent = state.suppliers.length;

        const totalDebt = state.customers.reduce((sum, cust) => sum + (cust.debt || 0), 0);
        document.getElementById('total-debts-stat').textContent = formatCurrency(totalDebt);

        const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
        const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);
        const todaySales = state.sales.filter(s => new Date(s.date) >= todayStart && new Date(s.date) <= todayEnd);
        const totalSalesTodayAmount = todaySales.reduce((sum, sale) => sum + sale.totalAmount, 0);
        document.getElementById('total-sales-today-stat').textContent = formatCurrency(totalSalesTodayAmount);

        const lowStockCount = state.products.filter(p => p.quantity > 0 && p.quantity <= (p.reorderLimit || 0)).length;
        document.getElementById('low-stock-products-stat').textContent = lowStockCount;
        
        const now = new Date();
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
        const monthExpenses = state.expenses.filter(exp => { const d = new Date(exp.date); return d >= monthStart && d <= monthEnd; });
        const totalMonthExpensesAmount = monthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
        document.getElementById('total-expenses-month-stat').textContent = formatCurrency(totalMonthExpensesAmount);

        const latestSalesTableBody = document.querySelector('#latest-sales-table tbody');
        if (latestSalesTableBody) {
            latestSalesTableBody.innerHTML = '';
            const latestFiveSales = [...state.sales].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            if(latestFiveSales.length === 0) latestSalesTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ูุง ุชูุฌุฏ ูุจูุนุงุช ุญุฏูุซุฉ.</td></tr>';
            else latestFiveSales.forEach(sale => {
                const customer = sale.customerId ? state.customers.find(c => c.id === sale.customerId) : null;
                const row = latestSalesTableBody.insertRow();
                const sym = sale.currencySymbol || state.currency.symbol;
                row.innerHTML = `<td>${sale.id}</td><td>${formatDate(sale.date)}</td>
                    <td>${customer ? customer.name : 'ุนููู ุนุงู'}</td><td>${parseFloat(sale.totalAmount).toFixed(2)} ${sym}</td>
                    <td><button class="small primary" onclick="viewSaleDetails('${sale.id}')"><span class="icon">๐๏ธ</span> ุนุฑุถ</button></td>`;
            });
        }
        const latestPurchaseOrdersTableBody = document.querySelector('#latest-purchase-orders-table tbody');
        if (latestPurchaseOrdersTableBody) {
            latestPurchaseOrdersTableBody.innerHTML = '';
            const sortedPOs = Array.isArray(state.purchaseOrders) ? [...state.purchaseOrders].sort((a,b) => new Date(b.date) - new Date(a.date)) : [];
            const latestFivePOs = sortedPOs.slice(0, 5);
            if(latestFivePOs.length === 0) latestPurchaseOrdersTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">ูุง ุชูุฌุฏ ุทูุจุงุช ุดุฑุงุก ุญุฏูุซุฉ.</td></tr>';
            else latestFivePOs.forEach(po => {
                const supplier = state.suppliers.find(s => s.id === po.supplierId);
                const row = latestPurchaseOrdersTableBody.insertRow();
                row.innerHTML = `<td>${po.id}</td><td>${supplier ? supplier.name : 'ุบูุฑ ูุญุฏุฏ'}</td><td>${formatDate(po.date)}</td>
                    <td><span class="badge ${getPOStatusClass(po.status)}">${getPOStatusText(po.status)}</span></td>
                    <td>${formatCurrency(po.totalAmount || 0)}</td>
                    <td><button class="small info" onclick="viewPurchaseOrderDetails('${po.id}')"><span class="icon">๐๏ธ</span> ุนุฑุถ</button></td>`;
            });
        }
    }

    // --- Suppliers Management ---
    const addSupplierBtn = document.getElementById('addSupplierBtn');
    if(addSupplierBtn) {
        addSupplierBtn.addEventListener('click', () => {
            buildForm([
                { id: 'supplierName', name: 'name', label: 'ุงุณู ุงูููุฑุฏ:', type: 'text', required: true },
                { id: 'supplierPhone', name: 'phone', label: 'ุงููุงุชู:', type: 'tel' },
                { id: 'supplierEmail', name: 'email', label: 'ุงูุจุฑูุฏ:', type: 'email' },
                { id: 'supplierAddress', name: 'address', label: 'ุงูุนููุงู:', type: 'textarea' },
                { id: 'supplierNotes', name: 'notes', label: 'ููุงุญุธุงุช:', type: 'textarea' }
            ], {}, handleSaveSupplier, 'ุฅุถุงูุฉ ููุฑุฏ ุฌุฏูุฏ');
        });
    }
    function handleSaveSupplier(supplierData) {
        if (supplierData.id) {
            const index = state.suppliers.findIndex(s => s.id === supplierData.id);
            if (index !== -1) state.suppliers[index] = { ...state.suppliers[index], ...supplierData };
        } else { state.suppliers.push({ id: generateId(), ...supplierData }); }
        saveState(); renderSuppliersTable(); renderDashboard(); showToast(`ุชู ${supplierData.id ? 'ุชุญุฏูุซ' : 'ุญูุธ'} ุงูููุฑุฏ!`);
    }
    function renderSuppliersTable() {
        const suppliersTableBody = document.querySelector('#suppliersTable tbody');
        if (!suppliersTableBody) return;
        suppliersTableBody.innerHTML = '';
        if (state.suppliers.length === 0) { suppliersTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">ูุง ููุฌุฏ ููุฑุฏูู.</td></tr>'; return; }
        state.suppliers.forEach((supplier, index) => {
            const row = suppliersTableBody.insertRow();
            row.innerHTML = `<td>${index + 1}</td><td>${supplier.name}</td><td>${supplier.phone || '-'}</td>
                <td>${supplier.email || '-'}</td><td>${supplier.address || '-'}</td>
                <td class="action-buttons">
                    <button class="small" onclick="editSupplier('${supplier.id}')"><span class="icon">โ๏ธ</span> ุชุนุฏูู</button>
                    <button class="small danger" onclick="confirmDeleteSupplier('${supplier.id}')"><span class="icon">๐๏ธ</span> ุญุฐู</button>
                </td>`;
        });
    }
    function editSupplier(id) {
        const supplier = state.suppliers.find(s => s.id === id);
        if (supplier) buildForm([
            { id: 'supplierName', name: 'name', label: 'ุงุณู ุงูููุฑุฏ:', type: 'text', required: true },
            { id: 'supplierPhone', name: 'phone', label: 'ุงููุงุชู:', type: 'tel' },
            { id: 'supplierEmail', name: 'email', label: 'ุงูุจุฑูุฏ:', type: 'email' },
            { id: 'supplierAddress', name: 'address', label: 'ุงูุนููุงู:', type: 'textarea' },
            { id: 'supplierNotes', name: 'notes', label: 'ููุงุญุธุงุช:', type: 'textarea' }
        ], supplier, handleSaveSupplier, 'ุชุนุฏูู ุงูููุฑุฏ');
    }
    function confirmDeleteSupplier(id) {
        if (state.purchaseOrders.some(po => po.supplierId === id)) { showToast('ูุง ูููู ุญุฐู ุงูููุฑุฏุ ูุฑุชุจุท ุจุทูุจุงุช ุดุฑุงุก.', 'error'); return; }
        showConfirmModal('ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงูููุฑุฏุ', () => deleteSupplier(id));
    }
    function deleteSupplier(id) {
        state.suppliers = state.suppliers.filter(s => s.id !== id);
        saveState(); renderSuppliersTable(); renderDashboard(); showToast('ุชู ุญุฐู ุงูููุฑุฏ.');
    }

    // --- Purchase Orders Management ---
    let currentPOItems = [];
    document.getElementById('addPurchaseOrderBtn')?.addEventListener('click', () => {
        if (state.suppliers.length === 0) { showToast("ุฃุถู ููุฑุฏูุง ุฃููุงู.", "error"); showPage('suppliers'); return; }
        document.getElementById('purchaseOrderModalTitle').textContent = 'ุฅูุดุงุก ุทูุจ ุดุฑุงุก ุฌุฏูุฏ';
        populatePOSupplierSelect(); currentPOItems = []; renderPOItemsTable();
        document.getElementById('purchaseOrderForm').reset();
        document.getElementById('poExpectedDate').value = formatDateForInput(new Date());
        if(purchaseOrderModalElement.dataset.editId) delete purchaseOrderModalElement.dataset.editId;
        openModal(purchaseOrderModalElement);
    });
    
    function populatePOSupplierSelect(selectedSupplierId = '') {
        const select = document.getElementById('poSupplierSelect'); if (!select) return;
        select.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูููุฑุฏ --</option>';
        state.suppliers.forEach(supplier => {
            const option = document.createElement('option');
            option.value = supplier.id; option.textContent = supplier.name;
            if (supplier.id === selectedSupplierId) option.selected = true;
            select.appendChild(option);
        });
    }

    document.getElementById('poProductSearch')?.addEventListener('input', (e) => {
        const poProductSearchResultsList = document.getElementById('poProductSearchResultsList');
        const searchTerm = e.target.value.toLowerCase().trim();
        poProductSearchResultsList.innerHTML = ''; if (!searchTerm) return;
        const matchedProducts = state.products.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.barcode && p.barcode.includes(searchTerm)));
        if (matchedProducts.length > 0) {
            const ul = document.createElement('ul');
            ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='0';
            matchedProducts.slice(0, 10).forEach(product => {
                const li = document.createElement('li');
                li.innerHTML = `<div>${product.name} (ุชูููุฉ: ${formatCurrency(product.costPrice || 0)})</div>`;
                li.style.padding='8px'; li.style.cursor='pointer'; li.style.borderBottom='1px solid #eee';
                li.onmouseover=()=>li.style.backgroundColor='#f0f0f0'; li.onmouseout=()=>li.style.backgroundColor='transparent';
                li.onclick = () => addProductToPO(product);
                ul.appendChild(li);
            });
            poProductSearchResultsList.appendChild(ul);
        } else { poProductSearchResultsList.innerHTML = '<div style="padding:8px;text-align:center;">ูุง ุชูุฌุฏ ููุชุฌุงุช ูุทุงุจูุฉ.</div>'; }
    });
    
    function addProductToPO(product) {
        const existingItem = currentPOItems.find(item => item.productId === product.id);
        if (existingItem) existingItem.quantity++;
        else currentPOItems.push({ productId: product.id, name: product.name, quantity: 1, costPrice: product.costPrice || 0, unit: product.unit });
        renderPOItemsTable();
        document.getElementById('poProductSearch').value = '';
        document.getElementById('poProductSearchResultsList').innerHTML = '';
        document.getElementById('poProductSearch').focus();
    }
    function updatePOItem(productId, field, value) {
        const item = currentPOItems.find(i => i.productId === productId);
        if (item) {
            const numValue = parseFloat(value);
            if (!isNaN(numValue)) {
                if (field === 'quantity' && numValue <= 0) removeProductFromPO(productId);
                else if (field === 'costPrice' && numValue < 0) item[field] = 0;
                else item[field] = numValue;
            }
            renderPOItemsTable();
        }
    }
    function removeProductFromPO(productId) {
        currentPOItems = currentPOItems.filter(item => item.productId !== productId);
        renderPOItemsTable();
    }
    function renderPOItemsTable() {
        const tbody = document.querySelector('#poItemsTable tbody'); if (!tbody) return;
        tbody.innerHTML = ''; let totalAmount = 0;
        currentPOItems.forEach(item => {
            const subtotal = (item.costPrice || 0) * item.quantity; totalAmount += subtotal;
            const row = tbody.insertRow();
            row.innerHTML = `<td>${item.name}</td>
                <td><input type="number" value="${item.quantity}" min="1" onchange="updatePOItem('${item.productId}', 'quantity', this.value)"></td>
                <td><input type="number" value="${item.costPrice || 0}" step="0.01" min="0" onchange="updatePOItem('${item.productId}', 'costPrice', this.value)"></td>
                <td>${formatCurrency(subtotal)}</td>
                <td><button type="button" class="small danger" onclick="removeProductFromPO('${item.productId}')"><span class="icon">๐๏ธ</span></button></td>`;
        });
        document.getElementById('poTotalAmount').textContent = formatCurrency(totalAmount);
    }
    document.getElementById('purchaseOrderForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const poData = Object.fromEntries(formData.entries());
        if (currentPOItems.length === 0) { showToast("ูุฌุจ ุฅุถุงูุฉ ููุชุฌุงุช ุฅูู ุงูุทูุจ ุฃููุงู.", "error"); return; }
        if (!poData.supplierId) { showToast("ูุฌุจ ุงุฎุชูุงุฑ ููุฑุฏ.", "error"); return; }
        const totalAmount = currentPOItems.reduce((sum, item) => sum + (item.costPrice || 0) * item.quantity, 0);
        const itemsWithSubtotal = currentPOItems.map(item => ({...item, subtotal: (item.costPrice || 0) * item.quantity }));
        const editId = purchaseOrderModalElement.dataset.editId;
        if (editId) {
            const poIndex = state.purchaseOrders.findIndex(po => po.id === editId);
            if (poIndex !== -1) {
                state.purchaseOrders[poIndex] = { ...state.purchaseOrders[poIndex],
                    supplierId: poData.supplierId, expectedDate: poData.expectedDate ? new Date(poData.expectedDate) : null,
                    notes: poData.notes, items: itemsWithSubtotal, totalAmount: totalAmount,
                }; showToast("ุชู ุชุญุฏูุซ ุทูุจ ุงูุดุฑุงุก!", "success");
            }
        } else {
            state.purchaseOrders.push({
                id: 'PO-' + generateId().substring(0,6).toUpperCase(), date: new Date(), supplierId: poData.supplierId,
                expectedDate: poData.expectedDate ? new Date(poData.expectedDate) : null, items: itemsWithSubtotal,
                totalAmount: totalAmount, status: 'pending', notes: poData.notes
            }); showToast("ุชู ุฅูุดุงุก ุทูุจ ุงูุดุฑุงุก!", "success");
        }
        saveState(); renderPurchaseOrdersTable(); renderDashboard(); closeModal(purchaseOrderModalElement);
    });
    
    function getPOStatusText(status) {
        const statuses = { pending: 'ููุฏ ุงูุงูุชุธุงุฑ', received_partial: 'ูุณุชูู ุฌุฒุฆููุง', received_full: 'ูุณุชูู ุจุงููุงูู', cancelled: 'ููุบู' };
        return statuses[status] || status;
    }
    function getPOStatusClass(status) {
        const classes = { pending: 'badge-warning', received_partial: 'badge-info', received_full: 'badge-success', cancelled: 'badge-danger' };
        return classes[status] || 'badge-secondary';
    }
    function renderPurchaseOrdersTable() {
        const purchaseOrdersTableBody = document.querySelector('#purchaseOrdersTable tbody');
        if (!purchaseOrdersTableBody) return;
        purchaseOrdersTableBody.innerHTML = '';
        const sortedPOs = Array.isArray(state.purchaseOrders) ? [...state.purchaseOrders].sort((a,b) => new Date(b.date) - new Date(a.date)) : [];
        if (sortedPOs.length === 0) { purchaseOrdersTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">ูุง ุชูุฌุฏ ุทูุจุงุช ุดุฑุงุก.</td></tr>'; return; }
        sortedPOs.forEach(po => {
            const supplier = state.suppliers.find(s => s.id === po.supplierId);
            const row = purchaseOrdersTableBody.insertRow();
            row.innerHTML = `<td>${po.id}</td><td>${supplier ? supplier.name : 'ุบูุฑ ูุญุฏุฏ'}</td>
                <td>${formatDate(po.date)}</td><td>${po.expectedDate ? formatDate(po.expectedDate) : '-'}</td>
                <td><span class="badge ${getPOStatusClass(po.status)}">${getPOStatusText(po.status)}</span></td>
                <td>${formatCurrency(po.totalAmount || 0)}</td>
                <td class="action-buttons">
                    <button class="small info" onclick="viewPurchaseOrderDetails('${po.id}')"><span class="icon">๐๏ธ</span> ุนุฑุถ</button>
                    <button class="small" onclick="editPurchaseOrder('${po.id}')" ${po.status === 'received_full' || po.status === 'cancelled' ? 'disabled' : ''}><span class="icon">โ๏ธ</span> ุชุนุฏูู</button>
                    ${po.status === 'pending' ? `<button class="small success" onclick="confirmReceivePO('${po.id}')"><span class="icon">โ๏ธ</span> ุงุณุชูุงู</button>` : ''}
                    ${po.status === 'pending' || po.status === 'received_partial' ? `<button class="small danger" onclick="confirmCancelPO('${po.id}')"><span class="icon">โ</span> ุฅูุบุงุก</button>` : ''}
                </td>`;
        });
    }
    function editPurchaseOrder(poId) {
        const po = state.purchaseOrders.find(p => p.id === poId); if (!po) return;
        if (po.status === 'received_full' || po.status === 'cancelled') { showToast("ูุง ูููู ุชุนุฏูู ุทูุจ ูุณุชูู ุฃู ููุบู.", "info"); return; }
        document.getElementById('purchaseOrderModalTitle').textContent = `ุชุนุฏูู ุทูุจ ุงูุดุฑุงุก ${po.id}`;
        purchaseOrderModalElement.dataset.editId = po.id;
        populatePOSupplierSelect(po.supplierId);
        document.getElementById('poExpectedDate').value = po.expectedDate ? formatDateForInput(po.expectedDate) : '';
        document.getElementById('poNotes').value = po.notes || '';
        currentPOItems = structuredClone(po.items); renderPOItemsTable(); openModal(purchaseOrderModalElement);
    }
    function viewPurchaseOrderDetails(poId) {
        const po = state.purchaseOrders.find(p => p.id === poId); if (!po) return;
        const supplier = state.suppliers.find(s => s.id === po.supplierId);
        let detailsHtml = `<p><strong>ุงูููุฑุฏ:</strong> ${supplier ? supplier.name : '-'}</p>
                           <p><strong>ุชุงุฑูุฎ ุงูุทูุจ:</strong> ${formatDate(po.date)}</p>
                           <p><strong>ุงูุงุณุชูุงู ุงููุชููุน:</strong> ${po.expectedDate ? formatDate(po.expectedDate) : '-'}</p>
                           <p><strong>ุงูุญุงูุฉ:</strong> <span class="badge ${getPOStatusClass(po.status)}">${getPOStatusText(po.status)}</span></p>
                           <p><strong>ุงูููุงุญุธุงุช:</strong> ${po.notes || '-'}</p>
                           <h4>ุงูุฃุตูุงู ุงููุทููุจุฉ:</h4><div class="table-responsive-wrapper"><table style="font-size: 0.9em;"><thead><tr><th>ุงูููุชุฌ</th><th>ุงููููุฉ</th><th>ุชูููุฉ ุงููุญุฏุฉ</th><th>ุงูุฅุฌูุงูู</th></tr></thead><tbody>`;
        (po.items || []).forEach(item => {
            detailsHtml += `<tr><td>${item.name}</td><td>${item.quantity} ${getUnitName(item.unit)}</td><td>${formatCurrency(item.costPrice || 0)}</td><td>${formatCurrency((item.costPrice || 0) * item.quantity)}</td></tr>`;
        });
        detailsHtml += `</tbody></table></div><hr><p style="text-align:left;font-weight:bold;font-size:1.1em;">ุงูุฅุฌูุงูู ุงูููู ููุทูุจ: ${formatCurrency(po.totalAmount || 0)}</p>`;
        document.getElementById('viewDetailsTitle').innerHTML = `ุชูุงุตูู ุทูุจ ุงูุดุฑุงุก ุฑูู: ${po.id}`;
        document.getElementById('viewDetailsBody').innerHTML = detailsHtml;
        document.getElementById('viewDetailsActions').innerHTML = '';
        openModal(viewDetailsModalElement);
    }
    function confirmReceivePO(poId) {
        showConfirmModal(`ูู ุชุคูุฏ ุงุณุชูุงู ุทูุจ ุงูุดุฑุงุก ${poId}ุ ุณูุชู ุชุญุฏูุซ ุงููุฎุฒูู ุจูุฐู ุงููููุงุช.`, () => receivePurchaseOrder(poId), 'ุชุฃููุฏ ุงูุงุณุชูุงู');
    }
    function receivePurchaseOrder(poId) {
        const po = state.purchaseOrders.find(p => p.id === poId);
        if (!po || po.status !== 'pending') { showToast("ูุง ูููู ุงุณุชูุงู ูุฐุง ุงูุทูุจ.", "error"); return; }
        (po.items || []).forEach(item => {
            const product = state.products.find(p => p.id === item.productId);
            if (product) {
                product.quantity += item.quantity;
                product.costPrice = item.costPrice;
            }
        });
        po.status = 'received_full'; po.receivedDate = new Date();
        saveState(); renderPurchaseOrdersTable(); renderInventoryTable(); renderDashboard(); renderProductsTable();
        showToast(`ุชู ุงุณุชูุงู ุทูุจ ุงูุดุฑุงุก ${poId} ูุชุญุฏูุซ ุงููุฎุฒูู.`, "success");
    }
    function confirmCancelPO(poId) {
         showConfirmModal(`ูู ุชุฑูุฏ ุฅูุบุงุก ุทูุจ ุงูุดุฑุงุก ${poId}ุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.`, () => cancelPurchaseOrder(poId), 'ุชุฃููุฏ ุงูุฅูุบุงุก');
    }
    function cancelPurchaseOrder(poId) {
        const po = state.purchaseOrders.find(p => p.id === poId);
        if (!po || (po.status !== 'pending' && po.status !== 'received_partial')) { showToast("ูุง ูููู ุฅูุบุงุก ูุฐุง ุงูุทูุจ.", "error"); return; }
        po.status = 'cancelled';
        saveState(); renderPurchaseOrdersTable(); renderDashboard(); showToast(`ุชู ุฅูุบุงุก ุทูุจ ุงูุดุฑุงุก ${poId}.`, "success");
    }

    // --- Quotations Management ---
    let currentQuoteItems = [];
    document.getElementById('addQuotationBtn')?.addEventListener('click', () => {
        if (state.customers.length === 0) { showToast("ุฃุถู ุนูููุงู ุฃููุงู.", "error"); showPage('customers'); return; }
        document.getElementById('quotationModalTitle').textContent = 'ุฅูุดุงุก ุนุฑุถ ุณุนุฑ ุฌุฏูุฏ';
        populateQuoteCustomerSelect();
        currentQuoteItems = [];
        renderQuoteItemsTable();
        document.getElementById('quotationForm').reset();
        if(quotationModalElement.dataset.editId) delete quotationModalElement.dataset.editId;
        openModal(quotationModalElement);
    });

    function populateQuoteCustomerSelect(selectedCustomerId = '') {
        const select = document.getElementById('quoteCustomerSelect'); if(!select) return;
        select.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูุนููู --</option>';
        state.customers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.id;
            option.textContent = customer.name;
            if(customer.id === selectedCustomerId) option.selected = true;
            select.appendChild(option);
        });
    }

    document.getElementById('quoteProductSearch')?.addEventListener('input', (e) => {
        const searchResultsList = document.getElementById('quoteProductSearchResultsList');
        const searchTerm = e.target.value.toLowerCase().trim();
        searchResultsList.innerHTML = '';
        if (!searchTerm) return;
        const matchedProducts = state.products.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.barcode && p.barcode.includes(searchTerm)));
        if (matchedProducts.length > 0) {
            const ul = document.createElement('ul');
            ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='0';
            matchedProducts.slice(0, 10).forEach(product => {
                const li = document.createElement('li');
                li.innerHTML = `<div>${product.name} (ุงูุณุนุฑ: ${formatCurrency(product.price)})</div>`;
                li.style.padding='8px'; li.style.cursor='pointer'; li.style.borderBottom='1px solid #eee';
                li.onmouseover=()=>li.style.backgroundColor='#f0f0f0'; li.onmouseout=()=>li.style.backgroundColor='transparent';
                li.onclick = () => addProductToQuote(product);
                ul.appendChild(li);
            });
            searchResultsList.appendChild(ul);
        } else {
            searchResultsList.innerHTML = '<div style="padding:8px;text-align:center;">ูุง ุชูุฌุฏ ููุชุฌุงุช ูุทุงุจูุฉ.</div>';
        }
    });

    function addProductToQuote(product) {
        const existingItem = currentQuoteItems.find(item => item.productId === product.id);
        if (existingItem) {
            existingItem.quantity++;
        } else {
            currentQuoteItems.push({
                productId: product.id, name: product.name, quantity: 1,
                price: product.price, unit: product.unit
            });
        }
        renderQuoteItemsTable();
        document.getElementById('quoteProductSearch').value = '';
        document.getElementById('quoteProductSearchResultsList').innerHTML = '';
        document.getElementById('quoteProductSearch').focus();
    }
    
    function updateQuoteItem(productId, field, value) {
        const item = currentQuoteItems.find(i => i.productId === productId);
        if (item) {
            const numValue = parseFloat(value);
            if(!isNaN(numValue)) {
                if (field === 'quantity' && numValue <= 0) removeProductFromQuote(productId);
                else if (field === 'price' && numValue < 0) item[field] = 0;
                else item[field] = numValue;
            }
            renderQuoteItemsTable();
        }
    }
    
    function removeProductFromQuote(productId) {
        currentQuoteItems = currentQuoteItems.filter(item => item.productId !== productId);
        renderQuoteItemsTable();
    }

    function renderQuoteItemsTable() {
        const tbody = document.querySelector('#quoteItemsTable tbody'); if (!tbody) return;
        tbody.innerHTML = '';
        let subtotal = 0;
        currentQuoteItems.forEach(item => {
            item.subtotal = (item.price || 0) * item.quantity;
            subtotal += item.subtotal;
            const row = tbody.insertRow();
            row.innerHTML = `<td>${item.name}</td>
                <td><input type="number" value="${item.quantity}" min="1" onchange="updateQuoteItem('${item.productId}', 'quantity', this.value)"></td>
                <td><input type="number" value="${item.price || 0}" step="0.01" min="0" onchange="updateQuoteItem('${item.productId}', 'price', this.value)"></td>
                <td>${formatCurrency(item.subtotal)}</td>
                <td><button type="button" class="small danger" onclick="removeProductFromQuote('${item.productId}')"><span class="icon">๐๏ธ</span></button></td>`;
        });
        const taxAmount = subtotal * state.taxRate;
        const totalAmount = subtotal + taxAmount;
        document.getElementById('quoteSubtotalAmount').textContent = formatCurrency(subtotal);
        document.getElementById('quoteTaxAmount').textContent = formatCurrency(taxAmount);
        document.getElementById('quoteTotalAmount').textContent = formatCurrency(totalAmount);
    }
    
    document.getElementById('quotationForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const quoteData = Object.fromEntries(formData.entries());
        if (currentQuoteItems.length === 0) { showToast("ูุฌุจ ุฅุถุงูุฉ ุฃุตูุงู ุฅูู ุนุฑุถ ุงูุณุนุฑ.", "error"); return; }
        if (!quoteData.customerId) { showToast("ูุฌุจ ุงุฎุชูุงุฑ ุนููู.", "error"); return; }

        let subtotalAmount = 0;
        const itemsWithSubtotal = currentQuoteItems.map(item => {
            const subtotal = (item.price || 0) * item.quantity;
            subtotalAmount += subtotal;
            return {...item, subtotal};
        });
        const taxAmount = subtotalAmount * state.taxRate;
        const totalAmount = subtotalAmount + taxAmount;
        
        const editId = quotationModalElement.dataset.editId;
        if (editId) {
            const quoteIndex = state.quotations.findIndex(q => q.id === editId);
            if (quoteIndex !== -1) {
                const oldStatus = state.quotations[quoteIndex].status;
                state.quotations[quoteIndex] = { ...state.quotations[quoteIndex],
                    customerId: quoteData.customerId,
                    notes: quoteData.notes,
                    items: itemsWithSubtotal,
                    subtotalAmount, taxAmount, totalAmount
                };
                showToast("ุชู ุชุญุฏูุซ ุนุฑุถ ุงูุณุนุฑ!", "success");
            }
        } else {
            state.quotations.push({
                id: 'QT-' + generateId().substring(0,6).toUpperCase(),
                date: new Date(),
                customerId: quoteData.customerId,
                items: itemsWithSubtotal,
                subtotalAmount, taxAmount, totalAmount,
                status: 'draft',
                notes: quoteData.notes
            });
            showToast("ุชู ุฅูุดุงุก ุนุฑุถ ุงูุณุนุฑ!", "success");
        }
        saveState();
        renderQuotationsTable();
        closeModal(quotationModalElement);
    });
    
    function getQuoteStatusText(status) {
        const statuses = { draft: 'ูุณูุฏุฉ', sent: 'ูุฑุณู', accepted: 'ููุจูู', rejected: 'ูุฑููุถ', invoiced: 'ุชูุช ููุชุฑุชู'};
        return statuses[status] || status;
    }
    function getQuoteStatusClass(status) {
        const classes = { draft: 'badge-secondary', sent: 'badge-info', accepted: 'badge-success', rejected: 'badge-danger', invoiced: 'badge-primary'};
        return classes[status] || 'badge-secondary';
    }

    function renderQuotationsTable() {
        const quotationsTableBody = document.querySelector('#quotationsTable tbody');
        if(!quotationsTableBody) return;
        quotationsTableBody.innerHTML = '';
        const sortedQuotes = [...state.quotations].sort((a,b) => new Date(b.date) - new Date(a.date));

        if (sortedQuotes.length === 0) {
            quotationsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">ูุง ุชูุฌุฏ ุนุฑูุถ ุฃุณุนุงุฑ.</td></tr>';
            return;
        }
        sortedQuotes.forEach(quote => {
            const customer = state.customers.find(c => c.id === quote.customerId);
            const row = quotationsTableBody.insertRow();
            row.innerHTML = `<td>${quote.id}</td>
                <td>${customer ? customer.name : 'ุบูุฑ ูุญุฏุฏ'}</td>
                <td>${formatDate(quote.date)}</td>
                <td><span class="badge ${getQuoteStatusClass(quote.status)}">${getQuoteStatusText(quote.status)}</span></td>
                <td>${formatCurrency(quote.totalAmount || 0)}</td>
                <td class="action-buttons">
                    <button class="small info" onclick="viewQuotationDetails('${quote.id}')"><span class="icon">๐๏ธ</span> ุนุฑุถ</button>
                    <button class="small" onclick="editQuotation('${quote.id}')" ${quote.status === 'invoiced' ? 'disabled' : ''}><span class="icon">โ๏ธ</span> ุชุนุฏูู</button>
                    <button class="small danger" onclick="confirmDeleteQuotation('${quote.id}')"><span class="icon">๐๏ธ</span> ุญุฐู</button>
                </td>`;
        });
    }

    function editQuotation(quoteId) {
        const quote = state.quotations.find(q => q.id === quoteId);
        if (!quote) return;
        if(quote.status === 'invoiced') {
            showToast('ูุง ูููู ุชุนุฏูู ุนุฑุถ ุณุนุฑ ุชูุช ููุชุฑุชู.', 'info');
            return;
        }

        document.getElementById('quotationModalTitle').textContent = `ุชุนุฏูู ุนุฑุถ ุงูุณุนุฑ ${quote.id}`;
        quotationModalElement.dataset.editId = quote.id;
        populateQuoteCustomerSelect(quote.customerId);
        document.getElementById('quoteNotes').value = quote.notes || '';
        currentQuoteItems = structuredClone(quote.items);
        renderQuoteItemsTable();
        openModal(quotationModalElement);
    }
    
    function confirmDeleteQuotation(quoteId) {
        showConfirmModal('ูู ุชุฑูุฏ ุญุฐู ุนุฑุถ ุงูุณุนุฑ ูุฐุงุ', () => deleteQuotation(quoteId));
    }

    function deleteQuotation(quoteId) {
        state.quotations = state.quotations.filter(q => q.id !== quoteId);
        saveState();
        renderQuotationsTable();
        showToast('ุชู ุญุฐู ุนุฑุถ ุงูุณุนุฑ.');
    }

    function viewQuotationDetails(quoteId) {
        const quote = state.quotations.find(q => q.id === quoteId);
        if (!quote) return;

        const customer = state.customers.find(s => s.id === quote.customerId);
        const canBeInvoiced = quote.status !== 'invoiced' && quote.status !== 'rejected';
        
        let detailsHtml = `<p><strong>ุงูุนููู:</strong> ${customer ? customer.name : '-'}</p>
                           <p><strong>ุชุงุฑูุฎ ุงูุนุฑุถ:</strong> ${formatDate(quote.date)}</p>
                           <p><strong>ุงูุญุงูุฉ:</strong> <span class="badge ${getQuoteStatusClass(quote.status)}">${getQuoteStatusText(quote.status)}</span></p>
                           <p><strong>ุงูููุงุญุธุงุช:</strong> ${quote.notes || '-'}</p>
                           <h4>ุงูุฃุตูุงู:</h4><div class="table-responsive-wrapper"><table style="font-size: 0.9em;"><thead><tr><th>ุงูููุชุฌ</th><th>ุงููููุฉ</th><th>ุณุนุฑ ุงููุญุฏุฉ</th><th>ุงูุฅุฌูุงูู</th></tr></thead><tbody>`;

        (quote.items || []).forEach(item => {
            detailsHtml += `<tr><td>${item.name}</td><td>${item.quantity} ${getUnitName(item.unit)}</td><td>${formatCurrency(item.price || 0)}</td><td>${formatCurrency(item.subtotal)}</td></tr>`;
        });
        
        const summaryHtml = `<p><strong>ุงูุฅุฌูุงูู ุงููุฑุนู:</strong> ${formatCurrency(quote.subtotalAmount)}</p>
                             <p><strong>ุงูุถุฑูุจุฉ (${(state.taxRate * 100).toFixed(0)}%):</strong> ${formatCurrency(quote.taxAmount)}</p>
                             <p><strong>ุงูุฅุฌูุงูู ุงูููู ููุนุฑุถ:</strong> ${formatCurrency(quote.totalAmount)}</p>`;
                             
        detailsHtml += `</tbody></table></div><hr><div style="text-align:left;font-weight:bold;font-size:1.1em;">${summaryHtml}</div>`;
        
        document.getElementById('viewDetailsTitle').innerHTML = `ุชูุงุตูู ุนุฑุถ ุงูุณุนุฑ ุฑูู: ${quote.id}`;
        document.getElementById('viewDetailsBody').innerHTML = detailsHtml;

        const actionsContainer = document.getElementById('viewDetailsActions');
        actionsContainer.innerHTML = `<button class="primary small" onclick="handlePrintQuote('${quote.id}')"><span class="icon">๐จ๏ธ</span> ุทุจุงุนุฉ</button>`;
        
        openModal(viewDetailsModalElement);
    }

    function handlePrintQuote(quoteId) {
        const quote = state.quotations.find(q => q.id === quoteId);
        if (!quote) { showToast('ุนุฑุถ ุงูุณุนุฑ ุบูุฑ ููุฌูุฏ.', 'error'); return; }
        const quoteHtmlContent = generateInvoiceHTML(quote, 'quote');
        const invoiceToPrintDiv = document.getElementById('invoiceToPrint');
        if(invoiceToPrintDiv) {
            invoiceToPrintDiv.innerHTML = quoteHtmlContent;
            window.print();
        }
    }


    // --- Expenses Management ---
    const addExpenseBtn = document.getElementById('addExpenseBtn');
    const filterExpensesBtn = document.getElementById('filterExpensesBtn');
    const clearExpenseFilterBtn = document.getElementById('clearExpenseFilterBtn');
    const expenseStartDateInput = document.getElementById('expenseStartDate');
    const expenseEndDateInput = document.getElementById('expenseEndDate');
    const totalFilteredExpensesSpan = document.getElementById('totalFilteredExpenses');
    const expenseCategories = [
        { value: "rent", text: "ุฅูุฌุงุฑ" }, { value: "utilities", text: "ููุงุชูุฑ ูุฎุฏูุงุช" }, { value: "salaries", text: "ุฑูุงุชุจ" },
        { value: "supplies", text: "ูุณุชูุฒูุงุช ููุชุจูุฉ" }, { value: "marketing", text: "ุชุณููู ูุฅุนูุงู" },
        { value: "maintenance", text: "ุตูุงูุฉ" }, { value: "other", text: "ุฃุฎุฑู" }
    ];
    if(addExpenseBtn) {
        addExpenseBtn.addEventListener('click', () => {
            buildForm([
                { id: 'expenseDate', name: 'date', label: 'ุงูุชุงุฑูุฎ:', type: 'date', required: true },
                { id: 'expenseDescription', name: 'description', label: 'ุงููุตู:', type: 'text', required: true },
                { id: 'expenseCategory', name: 'category', label: 'ุงููุฆุฉ:', type: 'select', options: [{value: '', text: 'ุงุฎุชุฑ ูุฆุฉ'}, ...expenseCategories], required: true },
                { id: 'expenseAmount', name: 'amount', label: `ุงููุจูุบ (${state.currency.symbol}):`, type: 'number', step: '0.01', min: 0.01, required: true },
                { id: 'expenseNotes', name: 'notes', label: 'ููุงุญุธุงุช:', type: 'textarea' }
            ], { date: new Date().toISOString() }, handleSaveExpense, 'ุฅุถุงูุฉ ูุตุฑูู ุฌุฏูุฏ');
        });
    }
    function handleSaveExpense(expenseData) {
        expenseData.amount = parseFloat(expenseData.amount);
        if (expenseData.id) {
            const index = state.expenses.findIndex(exp => exp.id === expenseData.id);
            if (index !== -1) state.expenses[index] = { ...state.expenses[index], ...expenseData };
        } else { state.expenses.push({ id: generateId(), ...expenseData }); }
        saveState(); renderExpensesTable(); renderDashboard(); showToast(`ุชู ${expenseData.id ? 'ุชุญุฏูุซ' : 'ุญูุธ'} ุงููุตุฑูู!`);
    }
    function renderExpensesTable() {
        const expensesTableBody = document.querySelector('#expensesTable tbody');
        if (!expensesTableBody || !totalFilteredExpensesSpan) return;
        expensesTableBody.innerHTML = '';
        let filteredExpenses = [...state.expenses];
        const startDate = expenseStartDateInput?.value ? new Date(expenseStartDateInput.value) : null;
        const endDate = expenseEndDateInput?.value ? new Date(expenseEndDateInput.value) : null;
        if (startDate) { startDate.setHours(0,0,0,0); filteredExpenses = filteredExpenses.filter(exp => new Date(exp.date) >= startDate); }
        if (endDate) { endDate.setHours(23,59,59,999); filteredExpenses = filteredExpenses.filter(exp => new Date(exp.date) <= endDate); }
        filteredExpenses.sort((a,b) => new Date(b.date) - new Date(a.date));
        let currentTotalExpenses = 0;
        if (filteredExpenses.length === 0) { expensesTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">ูุง ุชูุฌุฏ ูุตุฑููุงุช ุชุทุงุจู ุงูููุชุฑ.</td></tr>'; }
        else {
            filteredExpenses.forEach((expense, index) => {
                const row = expensesTableBody.insertRow();
                const categoryObj = expenseCategories.find(cat => cat.value === expense.category);
                currentTotalExpenses += expense.amount;
                row.innerHTML = `<td>${index + 1}</td><td>${formatDate(expense.date)}</td><td>${expense.description}</td>
                    <td>${categoryObj ? categoryObj.text : expense.category}</td><td>${formatCurrency(expense.amount)}</td>
                    <td class="action-buttons">
                        <button class="small" onclick="editExpense('${expense.id}')"><span class="icon">โ๏ธ</span> ุชุนุฏูู</button>
                        <button class="small danger" onclick="confirmDeleteExpense('${expense.id}')"><span class="icon">๐๏ธ</span> ุญุฐู</button>
                    </td>`;
            });
        }
        totalFilteredExpensesSpan.textContent = formatCurrency(currentTotalExpenses);
    }
    if (filterExpensesBtn) filterExpensesBtn.addEventListener('click', renderExpensesTable);
    if (clearExpenseFilterBtn) {
        clearExpenseFilterBtn.addEventListener('click', () => {
            if(expenseStartDateInput) expenseStartDateInput.value = '';
            if(expenseEndDateInput) expenseEndDateInput.value = '';
            renderExpensesTable();
        });
    }
    function editExpense(id) {
        const expense = state.expenses.find(exp => exp.id === id);
        if (expense) buildForm([
            { id: 'expenseDate', name: 'date', label: 'ุงูุชุงุฑูุฎ:', type: 'date', required: true },
            { id: 'expenseDescription', name: 'description', label: 'ุงููุตู:', type: 'text', required: true },
            { id: 'expenseCategory', name: 'category', label: 'ุงููุฆุฉ:', type: 'select', options: [{value: '', text: 'ุงุฎุชุฑ ูุฆุฉ'}, ...expenseCategories], required: true },
            { id: 'expenseAmount', name: 'amount', label: `ุงููุจูุบ (${state.currency.symbol}):`, type: 'number', step: '0.01', min: 0.01, required: true },
            { id: 'expenseNotes', name: 'notes', label: 'ููุงุญุธุงุช:', type: 'textarea' }
        ], {...expense, date: new Date(expense.date).toISOString()}, handleSaveExpense, 'ุชุนุฏูู ุงููุตุฑูู');
    }
    function confirmDeleteExpense(id) {
        showConfirmModal('ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงููุตุฑููุ', () => deleteExpense(id));
    }
    function deleteExpense(id) {
        state.expenses = state.expenses.filter(exp => exp.id !== id);
        saveState(); renderExpensesTable(); renderDashboard(); showToast('ุชู ุญุฐู ุงููุตุฑูู.');
    }

    // --- Responsive Sidebar Toggle ---
    const menuToggleBtn = document.getElementById('menuToggleBtn');
    const sidebarElement = document.getElementById('sidebar');
    const mainContentElement = document.getElementById('mainContent');

    if (menuToggleBtn && sidebarElement) {
        const iconMenu = menuToggleBtn.querySelector('.icon-menu');
        const iconClose = menuToggleBtn.querySelector('.icon-close');
        menuToggleBtn.addEventListener('click', () => {
            sidebarElement.classList.toggle('open');
            const isOpen = sidebarElement.classList.contains('open');
            if (iconMenu) iconMenu.style.display = isOpen ? 'none' : 'block';
            if (iconClose) iconClose.style.display = isOpen ? 'block' : 'none';
        });
        const closeSidebarOnContentClick = () => {
             if (window.innerWidth < 768 && sidebarElement.classList.contains('open')) {
                sidebarElement.classList.remove('open');
                if (iconMenu) iconMenu.style.display = 'block';
                if (iconClose) iconClose.style.display = 'none';
            }
        };
        mainContentElement.addEventListener('click', closeSidebarOnContentClick);
        sidebarElement.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', closeSidebarOnContentClick);
        });
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        showPage('dashboard');
    });

</script>
</body>
</html>
